
<!DOCTYPE html>

<html xmlns="http://www.w3.org/1999/xhtml">
  <head>
    <meta charset="utf-8" />
    <title>PyTrx.Area &#8212; PyTrx 1.1.0 documentation</title>
    <link rel="stylesheet" href="../../_static/classic.css" type="text/css" />
    <link rel="stylesheet" href="../../_static/pygments.css" type="text/css" />
    
    <script type="text/javascript" id="documentation_options" data-url_root="../../" src="../../_static/documentation_options.js"></script>
    <script type="text/javascript" src="../../_static/jquery.js"></script>
    <script type="text/javascript" src="../../_static/underscore.js"></script>
    <script type="text/javascript" src="../../_static/doctools.js"></script>
    <script type="text/javascript" src="../../_static/language_data.js"></script>
    
    <link rel="index" title="Index" href="../../genindex.html" />
    <link rel="search" title="Search" href="../../search.html" /> 
  </head><body>
    <div class="related" role="navigation" aria-label="related navigation">
      <h3>Navigation</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="../../genindex.html" title="General Index"
             accesskey="I">index</a></li>
        <li class="right" >
          <a href="../../py-modindex.html" title="Python Module Index"
             >modules</a> |</li>
        <li class="nav-item nav-item-0"><a href="../../index.html">PyTrx 1.1.0 documentation</a> &#187;</li>
          <li class="nav-item nav-item-1"><a href="../index.html" accesskey="U">Module code</a> &#187;</li> 
      </ul>
    </div>  

    <div class="document">
      <div class="documentwrapper">
        <div class="bodywrapper">
          <div class="body" role="main">
            
  <h1>Source code for PyTrx.Area</h1><div class="highlight"><pre>
<span></span><span class="c1">#PyTrx (c) by Penelope How, Nick Hulton, Lynne Buie</span>
<span class="c1">#</span>
<span class="c1">#PyTrx is licensed under a MIT License.</span>
<span class="c1">#</span>
<span class="c1">#You should have received a copy of the license along with this</span>
<span class="c1">#work. If not, see &lt;https://choosealicense.com/licenses/mit/&gt;.</span>

<span class="sd">&quot;&quot;&quot;</span>
<span class="sd">The Area module handles the functionality for obtaining areal measurements from </span>
<span class="sd">oblique time-lapse imagery. Specifically, this module contains functions for:</span>
<span class="sd">(1) Performing automated and manual detection of areal extents in oblique </span>
<span class="sd">imagery; and (2) Determining real-world surface areas from oblique imagery.                                                                                                                                </span>
<span class="sd">&quot;&quot;&quot;</span>

<span class="c1">#Import packages</span>
<span class="kn">import</span> <span class="nn">matplotlib.pyplot</span> <span class="k">as</span> <span class="nn">plt</span>
<span class="kn">from</span> <span class="nn">matplotlib.lines</span> <span class="k">import</span> <span class="n">Line2D</span>
<span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>
<span class="kn">import</span> <span class="nn">cv2</span>
<span class="kn">from</span> <span class="nn">PIL</span> <span class="k">import</span> <span class="n">Image</span>
<span class="kn">import</span> <span class="nn">ogr</span>

<span class="c1">#Import PyTrx functions and classes</span>
<span class="kn">from</span> <span class="nn">FileHandler</span> <span class="k">import</span> <span class="n">readMask</span>
<span class="kn">from</span> <span class="nn">Images</span> <span class="k">import</span> <span class="n">ImageSequence</span><span class="p">,</span> <span class="n">enhanceImage</span>
<span class="kn">import</span> <span class="nn">Velocity</span>
<span class="kn">from</span> <span class="nn">CamEnv</span> <span class="k">import</span> <span class="n">projectUV</span><span class="p">,</span> <span class="n">setProjection</span>

<span class="c1">#------------------------------------------------------------------------------</span>
<div class="viewcode-block" id="Area"><a class="viewcode-back" href="../../Modules.html#PyTrx.Area.Area">[docs]</a><span class="k">class</span> <span class="nc">Area</span><span class="p">(</span><span class="n">ImageSequence</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;A class for processing change in area (i.e. a lake or plume) through an </span>
<span class="sd">    image sequence, with methods to calculate extent change in an image plane </span>
<span class="sd">    (px) and real areal change via georectification.</span>
<span class="sd">       </span>
<span class="sd">    :param imageList: List of images, for the :class:`PyTrx.Images.ImageSequence` object</span>
<span class="sd">    :type imageList: str/list            </span>
<span class="sd">    :param cameraenv: Camera environment parameters which can be read into the :class:`PyTrx.CamEnv.CamEnv` object as a text file</span>
<span class="sd">    :type cameraenv: str           </span>
<span class="sd">    :param hmatrix: Homography matrix </span>
<span class="sd">    :type hmatrix: arr</span>
<span class="sd">    :param calibFlag: An indicator of whether images are calibrated, for the :class:`PyTrx.Images.ImageSequence` object</span>
<span class="sd">    :type calibFlag: bool          </span>
<span class="sd">    :param band: String denoting the desired image band, default to &#39;L&#39; (grayscale)</span>
<span class="sd">    :type band: str, optional</span>
<span class="sd">    :param equal: Flag denoting whether histogram equalisation is applied to images (histogram equalisation is applied if True). Default to True. </span>
<span class="sd">    :type equal: bool, optional                          </span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c1">#Initialisation of Area class object          </span>
    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">imageList</span><span class="p">,</span> <span class="n">cameraenv</span><span class="p">,</span> <span class="n">hmatrix</span><span class="p">,</span> <span class="n">calibFlag</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> 
                 <span class="n">band</span><span class="o">=</span><span class="s1">&#39;L&#39;</span><span class="p">,</span> <span class="n">equal</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>
        
        <span class="c1">#Initialise and inherit from the ImageSequence object</span>
        <span class="n">ImageSequence</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">imageList</span><span class="p">,</span> <span class="n">band</span><span class="p">,</span> <span class="n">equal</span><span class="p">)</span> 
        
        <span class="c1">#Set up class properties</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_camEnv</span> <span class="o">=</span> <span class="n">cameraenv</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_calibFlag</span> <span class="o">=</span> <span class="n">calibFlag</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_pxplot</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_maximg</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_mask</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_enhance</span> <span class="o">=</span> <span class="kc">None</span>
        
        <span class="k">if</span> <span class="n">hmatrix</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_hmatrix</span><span class="o">=</span><span class="n">hmatrix</span>
            <span class="n">hmat0</span><span class="o">=</span><span class="kc">None</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_hmatrix</span><span class="o">.</span><span class="n">insert</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">hmat0</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_hmatrix</span><span class="o">=</span><span class="kc">None</span>
            
            
<div class="viewcode-block" id="Area.calcAutoAreas"><a class="viewcode-back" href="../../Modules.html#PyTrx.Area.Area.calcAutoAreas">[docs]</a>    <span class="k">def</span> <span class="nf">calcAutoAreas</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">colour</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">verify</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Detects areas of interest from a sequence of images, and returns </span>
<span class="sd">        pixel and xyz areas. </span>
<span class="sd">        </span>
<span class="sd">        :param colour: Flag to denote whether colour range for detection should be defined for each image or only once, default to False</span>
<span class="sd">        :type colour: bool, optional </span>
<span class="sd">        :param verify: Flag to denote whether detected polygons should be manually verified by user, default to False</span>
<span class="sd">        :type verify: bool, optional           </span>
<span class="sd">        :returns: XYZ and UV area information</span>
<span class="sd">        :rtype: list</span>
<span class="sd">        &quot;&quot;&quot;</span>               
        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\n\n</span><span class="s1">COMMENCING AUTOMATED AREA DETECTION&#39;</span><span class="p">)</span>

        <span class="c1">#Get DEM from camera environment</span>
        <span class="n">dem</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_camEnv</span><span class="o">.</span><span class="n">getDEM</span><span class="p">()</span> 

        <span class="c1">#Get inverse projection variables through camera info               </span>
        <span class="n">invprojvars</span> <span class="o">=</span> <span class="n">setProjection</span><span class="p">(</span><span class="n">dem</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_camEnv</span><span class="o">.</span><span class="n">_camloc</span><span class="p">,</span> 
                                    <span class="bp">self</span><span class="o">.</span><span class="n">_camEnv</span><span class="o">.</span><span class="n">_camDirection</span><span class="p">,</span> 
                                    <span class="bp">self</span><span class="o">.</span><span class="n">_camEnv</span><span class="o">.</span><span class="n">_radCorr</span><span class="p">,</span> 
                                    <span class="bp">self</span><span class="o">.</span><span class="n">_camEnv</span><span class="o">.</span><span class="n">_tanCorr</span><span class="p">,</span> 
                                    <span class="bp">self</span><span class="o">.</span><span class="n">_camEnv</span><span class="o">.</span><span class="n">_focLen</span><span class="p">,</span> 
                                    <span class="bp">self</span><span class="o">.</span><span class="n">_camEnv</span><span class="o">.</span><span class="n">_camCen</span><span class="p">,</span> 
                                    <span class="bp">self</span><span class="o">.</span><span class="n">_camEnv</span><span class="o">.</span><span class="n">_refImage</span><span class="p">)</span>
            
        <span class="c1">#If user is only defining the color range once</span>
        <span class="k">if</span> <span class="n">colour</span> <span class="ow">is</span> <span class="kc">False</span><span class="p">:</span> 
            
            <span class="c1">#Define colour range if none is given</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_colourrange</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>

                <span class="c1">#Get image (either corrected or distorted)</span>
                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_calibFlag</span> <span class="ow">is</span> <span class="kc">True</span><span class="p">:</span>
                    <span class="n">cameraMatrix</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_camEnv</span><span class="o">.</span><span class="n">getCamMatrixCV2</span><span class="p">()</span>
                    <span class="n">distortP</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_camEnv</span><span class="o">.</span><span class="n">getDistortCoeffsCV2</span><span class="p">()</span>
                    <span class="n">setting</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_imageSet</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">_maximg</span><span class="p">]</span><span class="o">.</span><span class="n">getImageCorr</span><span class="p">(</span><span class="n">cameraMatrix</span><span class="p">,</span> 
                                                               <span class="n">distortP</span><span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">setting</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_imageSet</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">_maximg</span><span class="p">]</span><span class="o">.</span><span class="n">getImageArray</span><span class="p">()</span> 
    
                <span class="c1">#Get image name</span>
                <span class="n">setimn</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_imageSet</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">_maximg</span><span class="p">]</span><span class="o">.</span><span class="n">getImageName</span><span class="p">()</span>
                  
                <span class="c1">#Get mask and mask image if present</span>
                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_mask</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>                       
                    <span class="n">booleanMask</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_mask</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="nb">bool</span><span class="p">)</span>
                    <span class="n">booleanMask</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">invert</span><span class="p">(</span><span class="n">booleanMask</span><span class="p">)</span>
                    
                    <span class="c1">#Mask extent image with boolean array</span>
                    <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">booleanMask</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">setting</span><span class="p">)</span> <span class="c1">#Fit arrays to each other</span>
                    <span class="n">setting</span><span class="p">[</span><span class="n">booleanMask</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span> <span class="c1">#Mask image with boolean mask object       </span>
                       
                <span class="c1">#Enhance image if enhancement parameters given</span>
                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_enhance</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                    <span class="n">setting</span> <span class="o">=</span> <span class="n">enhanceImage</span><span class="p">(</span><span class="n">setting</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_enhance</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> 
                                           <span class="bp">self</span><span class="o">.</span><span class="n">_enhance</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="bp">self</span><span class="o">.</span><span class="n">_enhance</span><span class="p">[</span><span class="mi">2</span><span class="p">])</span>
                
                <span class="c1">#Define colour range</span>
                <span class="n">defineColourrange</span><span class="p">(</span><span class="n">setting</span><span class="p">,</span> <span class="n">setimn</span><span class="p">,</span> <span class="n">pxplot</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_pxplot</span><span class="p">)</span>    
            
        <span class="c1">#Set up output datasets</span>
        <span class="n">area</span><span class="o">=</span><span class="p">[]</span>
                       
        <span class="c1">#Cycle through image sequence (numbered from 0)</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">getLength</span><span class="p">()):</span>
            
            <span class="c1">#Get corrected/distorted image</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_calibFlag</span> <span class="ow">is</span> <span class="kc">True</span><span class="p">:</span>
                <span class="n">cameraMatrix</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_camEnv</span><span class="o">.</span><span class="n">getCamMatrixCV2</span><span class="p">()</span>
                <span class="n">distortP</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_camEnv</span><span class="o">.</span><span class="n">getDistortCoeffsCV2</span><span class="p">()</span>
                <span class="n">img1</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_imageSet</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">getImageCorr</span><span class="p">(</span><span class="n">cameraMatrix</span><span class="p">,</span> 
                                                      <span class="n">distortP</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">img1</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_imageSet</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">getImageArray</span><span class="p">()</span>

            <span class="c1">#Get image name</span>
            <span class="n">imn</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_imageSet</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">getImageName</span><span class="p">()</span>
               
            <span class="c1">#Make a copy of the image array</span>
            <span class="n">img2</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">copy</span><span class="p">(</span><span class="n">img1</span><span class="p">)</span>
            
            <span class="c1">#Mask image if mask is present</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_mask</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">booleanMask</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_mask</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="nb">bool</span><span class="p">)</span>
                <span class="n">booleanMask</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">invert</span><span class="p">(</span><span class="n">booleanMask</span><span class="p">)</span>
                
                <span class="c1">#Mask extent image with boolean array</span>
                <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">booleanMask</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">img2</span><span class="p">)</span> <span class="c1">#Fit arrays to each other</span>
                <span class="n">img2</span><span class="p">[</span><span class="n">booleanMask</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span> <span class="c1">#Mask image with boolean mask object</span>
            
            <span class="c1">#Enhance image if enhancement parameters are present</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_enhance</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">img2</span> <span class="o">=</span> <span class="n">enhanceImage</span><span class="p">(</span><span class="n">img2</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_enhance</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="bp">self</span><span class="o">.</span><span class="n">_enhance</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span>
                                    <span class="bp">self</span><span class="o">.</span><span class="n">_enhance</span><span class="p">[</span><span class="mi">2</span><span class="p">])</span>
            
            <span class="c1">#Define colour range if required</span>
            <span class="k">if</span> <span class="n">colour</span> <span class="ow">is</span> <span class="kc">True</span><span class="p">:</span>
                <span class="n">defineColourrange</span><span class="p">(</span><span class="n">img2</span><span class="p">,</span> <span class="n">imn</span><span class="p">,</span> <span class="n">pxplot</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_pxplot</span><span class="p">)</span>
            
            <span class="c1">#Calculate extent</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_hmatrix</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">out</span> <span class="o">=</span> <span class="n">calcAutoArea</span><span class="p">(</span><span class="n">img2</span><span class="p">,</span> <span class="n">imn</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_colourrange</span><span class="p">,</span> 
                                   <span class="bp">self</span><span class="o">.</span><span class="n">_hmatrix</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="bp">self</span><span class="o">.</span><span class="n">_threshold</span><span class="p">,</span> 
                                   <span class="n">invprojvars</span><span class="p">)</span>  
            <span class="k">else</span><span class="p">:</span>
                <span class="n">out</span> <span class="o">=</span> <span class="n">calcAutoArea</span><span class="p">(</span><span class="n">img2</span><span class="p">,</span> <span class="n">imn</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_colourrange</span><span class="p">,</span> <span class="kc">None</span><span class="p">,</span> 
                                   <span class="bp">self</span><span class="o">.</span><span class="n">_threshold</span><span class="p">,</span> <span class="n">invprojvars</span><span class="p">)</span>  
            
            <span class="n">area</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">out</span><span class="p">)</span>

            <span class="c1">#Clear memory</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_imageSet</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">clearImage</span><span class="p">()</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_imageSet</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">clearImageArray</span><span class="p">()</span>
        
        <span class="c1">#Verify areas if flag is true</span>
        <span class="k">if</span> <span class="n">verify</span> <span class="ow">is</span> <span class="kc">True</span><span class="p">:</span>
            <span class="n">area</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">verifyAreas</span><span class="p">(</span><span class="n">area</span><span class="p">,</span> <span class="n">invprojvars</span><span class="p">)</span>

        <span class="c1">#Return all xy coordinates and pixel extents                 </span>
        <span class="k">return</span> <span class="n">area</span></div>


<div class="viewcode-block" id="Area.calcManualAreas"><a class="viewcode-back" href="../../Modules.html#PyTrx.Area.Area.calcManualAreas">[docs]</a>    <span class="k">def</span> <span class="nf">calcManualAreas</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Manually define areas of interest in a sequence of images. User </span>
<span class="sd">        input is facilitated through an interactive plot to click around the </span>
<span class="sd">        area of interest</span>
<span class="sd">        </span>
<span class="sd">        :returns: XYZ and UV area information</span>
<span class="sd">        :rtype: list</span>
<span class="sd">        &quot;&quot;&quot;</span>               
        <span class="s1">&#39;</span><span class="se">\n\n</span><span class="s1">COMMENCING MANUAL AREA DETECTION&#39;</span>            
        <span class="c1">#Set up output dataset</span>
        <span class="n">area</span><span class="o">=</span><span class="p">[]</span>

        <span class="c1">#Get DEM from camera environment</span>
        <span class="n">dem</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_camEnv</span><span class="o">.</span><span class="n">getDEM</span><span class="p">()</span> 

        <span class="c1">#Get inverse projection variables through camera info               </span>
        <span class="n">invprojvars</span> <span class="o">=</span> <span class="n">setProjection</span><span class="p">(</span><span class="n">dem</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_camEnv</span><span class="o">.</span><span class="n">_camloc</span><span class="p">,</span> 
                                    <span class="bp">self</span><span class="o">.</span><span class="n">_camEnv</span><span class="o">.</span><span class="n">_camDirection</span><span class="p">,</span> 
                                    <span class="bp">self</span><span class="o">.</span><span class="n">_camEnv</span><span class="o">.</span><span class="n">_radCorr</span><span class="p">,</span> 
                                    <span class="bp">self</span><span class="o">.</span><span class="n">_camEnv</span><span class="o">.</span><span class="n">_tanCorr</span><span class="p">,</span> 
                                    <span class="bp">self</span><span class="o">.</span><span class="n">_camEnv</span><span class="o">.</span><span class="n">_focLen</span><span class="p">,</span> 
                                    <span class="bp">self</span><span class="o">.</span><span class="n">_camEnv</span><span class="o">.</span><span class="n">_camCen</span><span class="p">,</span> 
                                    <span class="bp">self</span><span class="o">.</span><span class="n">_camEnv</span><span class="o">.</span><span class="n">_refImage</span><span class="p">)</span>
                
        <span class="c1">#Cycle through images        </span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="p">(</span><span class="nb">range</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">getLength</span><span class="p">())):</span>
            
            <span class="c1">#Call corrected/uncorrected image</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_calibFlag</span> <span class="ow">is</span> <span class="kc">True</span><span class="p">:</span>
                <span class="n">img</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_imageSet</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">getImageCorr</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_camEnv</span><span class="o">.</span><span class="n">getCamMatrixCV2</span><span class="p">(),</span> 
                                                   <span class="bp">self</span><span class="o">.</span><span class="n">_camEnv</span><span class="o">.</span><span class="n">getDistortCoeffsCV2</span><span class="p">())</span>      
            <span class="k">else</span><span class="p">:</span>
                <span class="n">img</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_imageSet</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">getImageArray</span><span class="p">()</span>          

            <span class="c1">#Get image name</span>
            <span class="n">imn</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_imageSet</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">getImageName</span><span class="p">()</span>
            
            <span class="c1">#Manually define extent and append</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_hmatrix</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">polys</span> <span class="o">=</span> <span class="n">calcManualArea</span><span class="p">(</span><span class="n">img</span><span class="p">,</span> <span class="n">imn</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_hmatrix</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> 
                                       <span class="bp">self</span><span class="o">.</span><span class="n">_pxplot</span><span class="p">,</span> <span class="n">invprojvars</span><span class="p">)</span> 
            <span class="k">else</span><span class="p">:</span>
                <span class="n">polys</span> <span class="o">=</span> <span class="n">calcManualArea</span><span class="p">(</span><span class="n">img</span><span class="p">,</span> <span class="n">imn</span><span class="p">,</span> <span class="kc">None</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_pxplot</span><span class="p">,</span> 
                                       <span class="n">invprojvars</span><span class="p">)</span>                 
            <span class="n">area</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">polys</span><span class="p">)</span>
            
            <span class="c1">#Clear memory</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_imageSet</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">clearImage</span><span class="p">()</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_imageSet</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">clearImageArray</span><span class="p">()</span>
    
        <span class="c1">#Return all extents, all cropped images and corresponding image names       </span>
        <span class="k">return</span> <span class="n">area</span></div>
    
        
<div class="viewcode-block" id="Area.verifyAreas"><a class="viewcode-back" href="../../Modules.html#PyTrx.Area.Area.verifyAreas">[docs]</a>    <span class="k">def</span> <span class="nf">verifyAreas</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">areas</span><span class="p">,</span> <span class="n">invprojvars</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Method to manually verify all polygons in images. Plots sequential</span>
<span class="sd">        images with detected polygons and the user manually verifies them by </span>
<span class="sd">        clicking them.</span>
<span class="sd">        </span>
<span class="sd">        :param area: XYZ and UV area information</span>
<span class="sd">        :type area: list </span>
<span class="sd">        :param invprojvars: Inverse projection variables [X,Y,Z,uv0]</span>
<span class="sd">        :type invprojvars: list</span>
<span class="sd">        :param verified: Verified XYZ and UV area information</span>
<span class="sd">        :type verified: list </span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1">#Create output</span>
        <span class="n">verified</span> <span class="o">=</span> <span class="p">[]</span>
        
        <span class="c1">#Get UV point coordinates</span>
        <span class="n">uvpts</span><span class="o">=</span><span class="p">[</span><span class="n">item</span><span class="p">[</span><span class="mi">1</span><span class="p">][</span><span class="mi">1</span><span class="p">]</span> <span class="k">for</span> <span class="n">item</span> <span class="ow">in</span> <span class="n">areas</span><span class="p">]</span>
                
        <span class="c1">#Verify pixel polygons in each image        </span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">uvpts</span><span class="p">)):</span>
            
            <span class="c1">#Call corrected/uncorrected image</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_calibFlag</span> <span class="ow">is</span> <span class="kc">True</span><span class="p">:</span>
                <span class="n">img1</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_imageSet</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">getImageCorr</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_camEnv</span><span class="o">.</span><span class="n">getCamMatrixCV2</span><span class="p">(),</span> 
                                                    <span class="bp">self</span><span class="o">.</span><span class="n">_camEnv</span><span class="o">.</span><span class="n">getDistortCoeffsCV2</span><span class="p">())</span>      
            <span class="k">else</span><span class="p">:</span>
                <span class="n">img1</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_imageSet</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">getImageArray</span><span class="p">()</span>            
            
            <span class="c1">#Get image name</span>
            <span class="n">imn</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_imageSet</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">getImageName</span><span class="p">()</span>
            
            <span class="c1">#Verify polygons</span>
            <span class="n">img2</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">copy</span><span class="p">(</span><span class="n">img1</span><span class="p">)</span>
            
            <span class="k">if</span> <span class="mi">1</span><span class="p">:</span>                            
                <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\n</span><span class="s1">Verifying detected areas from &#39;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">imn</span><span class="p">))</span>
                
                <span class="c1">#Set up empty output list                </span>
                <span class="n">verf</span> <span class="o">=</span> <span class="p">[]</span>
                
                <span class="c1">#Function for click verification within a plot</span>
                <span class="k">def</span> <span class="nf">onpick</span><span class="p">(</span><span class="n">event</span><span class="p">):</span>
                    
                    <span class="c1">#Get XY coordinates for clicked point in a plot</span>
                    <span class="n">v</span> <span class="o">=</span> <span class="p">[]</span>
                    <span class="n">thisline</span> <span class="o">=</span> <span class="n">event</span><span class="o">.</span><span class="n">artist</span>
                    <span class="n">xdata</span> <span class="o">=</span> <span class="n">thisline</span><span class="o">.</span><span class="n">get_xdata</span><span class="p">()</span>
                    <span class="n">ydata</span> <span class="o">=</span> <span class="n">thisline</span><span class="o">.</span><span class="n">get_ydata</span><span class="p">()</span>
                    
                    <span class="c1">#Append XY coordinates</span>
                    <span class="k">for</span> <span class="n">x</span><span class="p">,</span><span class="n">y</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">xdata</span><span class="p">,</span><span class="n">ydata</span><span class="p">):</span>
                        <span class="n">v</span><span class="o">.</span><span class="n">append</span><span class="p">([</span><span class="n">x</span><span class="p">,</span><span class="n">y</span><span class="p">])</span>
                    <span class="n">v2</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">v</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">int32</span><span class="p">)</span><span class="o">.</span><span class="n">reshape</span><span class="p">((</span><span class="nb">len</span><span class="p">(</span><span class="n">xdata</span><span class="p">)),</span><span class="mi">2</span><span class="p">)</span>
                    <span class="n">verf</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">v2</span><span class="p">)</span>
                    
                    <span class="c1">#Verify extent if XY coordinates coincide with a</span>
                    <span class="c1">#detected area</span>
                    <span class="n">ind</span><span class="o">=</span><span class="n">event</span><span class="o">.</span><span class="n">ind</span>
                    <span class="nb">print</span> <span class="p">(</span><span class="s1">&#39;Verified extent at &#39;</span> <span class="o">+</span> 
                           <span class="nb">str</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">take</span><span class="p">(</span><span class="n">xdata</span><span class="p">,</span> <span class="n">ind</span><span class="p">)[</span><span class="mi">0</span><span class="p">])</span> <span class="o">+</span> <span class="s1">&#39;, &#39;</span> <span class="o">+</span> 
                           <span class="nb">str</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">take</span><span class="p">(</span><span class="n">ydata</span><span class="p">,</span> <span class="n">ind</span><span class="p">)[</span><span class="mi">0</span><span class="p">]))</span>
                
                <span class="c1">#Plot image</span>
                <span class="n">fig</span><span class="p">,</span> <span class="n">ax1</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">()</span>
                <span class="n">fig</span><span class="o">.</span><span class="n">canvas</span><span class="o">.</span><span class="n">set_window_title</span><span class="p">(</span><span class="n">imn</span> <span class="o">+</span> <span class="s1">&#39;: Click on valid areas.&#39;</span><span class="p">)</span>
                <span class="n">ax1</span><span class="o">.</span><span class="n">imshow</span><span class="p">(</span><span class="n">img2</span><span class="p">,</span> <span class="n">cmap</span><span class="o">=</span><span class="s1">&#39;gray&#39;</span><span class="p">)</span>
                
                <span class="c1">#Chane plot extent if pxplot variable is present</span>
                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_pxplot</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                    <span class="n">ax1</span><span class="o">.</span><span class="n">axis</span><span class="p">([</span><span class="bp">self</span><span class="o">.</span><span class="n">_pxplot</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span><span class="bp">self</span><span class="o">.</span><span class="n">_pxplot</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span>
                              <span class="bp">self</span><span class="o">.</span><span class="n">_pxplot</span><span class="p">[</span><span class="mi">2</span><span class="p">],</span><span class="bp">self</span><span class="o">.</span><span class="n">_pxplot</span><span class="p">[</span><span class="mi">3</span><span class="p">]])</span>
                
                <span class="c1">#Plot all detected areas</span>
                <span class="k">for</span> <span class="n">a</span> <span class="ow">in</span> <span class="n">uvpts</span><span class="p">[</span><span class="n">i</span><span class="p">]:</span>
                    <span class="n">x</span><span class="o">=</span><span class="p">[]</span>
                    <span class="n">y</span><span class="o">=</span><span class="p">[]</span>
                    <span class="k">for</span> <span class="n">b</span> <span class="ow">in</span> <span class="n">a</span><span class="p">:</span>
                        <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="n">b</span><span class="p">:</span>
                            <span class="n">x</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">c</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
                            <span class="n">y</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">c</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>
                    <span class="n">line</span> <span class="o">=</span> <span class="n">Line2D</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="n">linestyle</span><span class="o">=</span><span class="s1">&#39;-&#39;</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;y&#39;</span><span class="p">,</span> <span class="n">picker</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
                    <span class="n">ax1</span><span class="o">.</span><span class="n">add_line</span><span class="p">(</span><span class="n">line</span><span class="p">)</span>
                
                <span class="c1">#Verify extents using onpick function</span>
                <span class="n">fig</span><span class="o">.</span><span class="n">canvas</span><span class="o">.</span><span class="n">mpl_connect</span><span class="p">(</span><span class="s1">&#39;pick_event&#39;</span><span class="p">,</span> <span class="n">onpick</span><span class="p">)</span>
            
            <span class="c1">#Show plot</span>
            <span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span> 
            <span class="n">plt</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
            
            <span class="c1">#Append all verified extents</span>
            <span class="n">vpx</span><span class="o">=</span><span class="p">[]</span>
            <span class="n">vpx</span><span class="o">=</span><span class="n">verf</span>               
            
            <span class="c1">#Get areas of verified extents</span>
            <span class="n">h</span> <span class="o">=</span> <span class="n">img2</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
            <span class="n">w</span> <span class="o">=</span> <span class="n">img2</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
            <span class="n">px_im</span> <span class="o">=</span> <span class="n">Image</span><span class="o">.</span><span class="n">new</span><span class="p">(</span><span class="s1">&#39;L&#39;</span><span class="p">,</span> <span class="p">(</span><span class="n">w</span><span class="p">,</span><span class="n">h</span><span class="p">),</span> <span class="s1">&#39;black&#39;</span><span class="p">)</span>
            <span class="n">px_im</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">px_im</span><span class="p">)</span> 
            <span class="n">cv2</span><span class="o">.</span><span class="n">drawContours</span><span class="p">(</span><span class="n">px_im</span><span class="p">,</span> <span class="n">vpx</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="p">(</span><span class="mi">255</span><span class="p">,</span><span class="mi">255</span><span class="p">,</span><span class="mi">255</span><span class="p">),</span> <span class="mi">4</span><span class="p">)</span>
            <span class="k">for</span> <span class="n">p</span> <span class="ow">in</span> <span class="n">vpx</span><span class="p">:</span>
                <span class="n">cv2</span><span class="o">.</span><span class="n">fillConvexPoly</span><span class="p">(</span><span class="n">px_im</span><span class="p">,</span> <span class="n">p</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="p">(</span><span class="mi">255</span><span class="p">,</span><span class="mi">255</span><span class="p">,</span><span class="mi">255</span><span class="p">))</span>           
            <span class="n">output</span> <span class="o">=</span> <span class="n">Image</span><span class="o">.</span><span class="n">fromarray</span><span class="p">(</span><span class="n">px_im</span><span class="p">)</span>

            <span class="n">pixels</span> <span class="o">=</span> <span class="n">output</span><span class="o">.</span><span class="n">getdata</span><span class="p">()</span>
            <span class="n">values</span> <span class="o">=</span> <span class="p">[]</span>    
            <span class="k">for</span> <span class="n">px</span> <span class="ow">in</span> <span class="n">pixels</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">px</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
                    <span class="n">values</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">px</span><span class="p">)</span>
            <span class="n">pxext</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">values</span><span class="p">)</span>        
            <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Total verified extent: &#39;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">pxext</span><span class="p">))</span>  

            <span class="c1">#Get xyz coordinates with inverse projection</span>
            <span class="k">if</span> <span class="n">invprojvars</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">vxyzpts</span><span class="o">=</span><span class="p">[]</span>
                <span class="n">vxyzarea</span><span class="o">=</span><span class="p">[]</span>
                <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">vpx</span><span class="p">:</span>
                    <span class="c1">#Inverse project points </span>
                    <span class="n">proj</span><span class="o">=</span><span class="n">projectUV</span><span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="n">invprojvars</span><span class="p">)</span>           
                    <span class="n">vxyzpts</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">proj</span><span class="p">)</span>
                    <span class="n">ogrpol</span> <span class="o">=</span> <span class="n">getOGRArea</span><span class="p">(</span><span class="n">proj</span><span class="p">)</span>                   
                    <span class="n">vxyzarea</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">ogrpol</span><span class="o">.</span><span class="n">GetArea</span><span class="p">())</span>
                    
                <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Total verified area: &#39;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="nb">sum</span><span class="p">(</span><span class="n">vxyzarea</span><span class="p">))</span> <span class="o">+</span> <span class="s1">&#39; m&#39;</span><span class="p">)</span>            

            <span class="n">verified</span><span class="o">.</span><span class="n">append</span><span class="p">([[</span><span class="n">pxext</span><span class="p">,</span> <span class="n">vpx</span><span class="p">],[</span><span class="n">vxyzarea</span><span class="p">,</span> <span class="n">vxyzpts</span><span class="p">]])</span>                    
            
            <span class="c1">#Clear memory            </span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_imageSet</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">clearImage</span><span class="p">()</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_imageSet</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">clearImageArray</span><span class="p">()</span>
        
        <span class="c1">#Rewrite verified area data</span>
        <span class="k">return</span> <span class="n">verified</span></div>
        

<div class="viewcode-block" id="Area.setMax"><a class="viewcode-back" href="../../Modules.html#PyTrx.Area.Area.setMax">[docs]</a>    <span class="k">def</span> <span class="nf">setMax</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">maxMaskPath</span><span class="p">,</span> <span class="n">maxim</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Set image in sequence which pictures the maximum extent of the area</span>
<span class="sd">        of interest.</span>
<span class="sd">        </span>
<span class="sd">        :param maxMaskPath: File path to mask with maximum extent</span>
<span class="sd">        :type maxMaskPath: str</span>
<span class="sd">        :param maxim: Image with maximum extent</span>
<span class="sd">        :type maxim: arr</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1">#Calibrate image if calibration flag is true</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_calibFlag</span> <span class="ow">is</span> <span class="kc">True</span><span class="p">:</span>
            <span class="n">cameraMatrix</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_camEnv</span><span class="o">.</span><span class="n">getCamMatrixCV2</span><span class="p">()</span>
            <span class="n">distortP</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_camEnv</span><span class="o">.</span><span class="n">getDistortCoeffsCV2</span><span class="p">()</span>
            <span class="n">maxi</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_imageSet</span><span class="p">[</span><span class="n">maxim</span><span class="p">]</span><span class="o">.</span><span class="n">getImageCorr</span><span class="p">(</span><span class="n">cameraMatrix</span><span class="p">,</span> 
                                                               <span class="n">distortP</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">maxi</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_imageSet</span><span class="p">[</span><span class="n">maxim</span><span class="p">]</span><span class="o">.</span><span class="n">getImageArray</span><span class="p">()</span>
            
        <span class="c1">#Define mask on image with maximum areal extent</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_mask</span> <span class="o">=</span> <span class="n">readMask</span><span class="p">(</span><span class="n">maxi</span><span class="p">,</span> <span class="n">maxMaskPath</span><span class="p">)</span>
        
        <span class="c1">#Retain image sequence number for image with maximum extent</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_maximg</span> <span class="o">=</span> <span class="n">maxim</span></div>


<div class="viewcode-block" id="Area.setPXExt"><a class="viewcode-back" href="../../Modules.html#PyTrx.Area.Area.setPXExt">[docs]</a>    <span class="k">def</span> <span class="nf">setPXExt</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">xmin</span><span class="p">,</span><span class="n">xmax</span><span class="p">,</span><span class="n">ymin</span><span class="p">,</span><span class="n">ymax</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Set plotting extent. Setting the plot extent will make it easier to </span>
<span class="sd">        define colour ranges and verify areas.</span>
<span class="sd">        </span>
<span class="sd">        :param xmin: X-axis minimum value.</span>
<span class="sd">        :type xmin: int</span>
<span class="sd">        :param xmax: X-axis maximum value.</span>
<span class="sd">        :type xmax: int</span>
<span class="sd">        :param ymin: Y-axis minimum value.</span>
<span class="sd">        :type ymin: int</span>
<span class="sd">        :param ymax: Y-axis maximum value.</span>
<span class="sd">        :type ymax: int</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_pxplot</span> <span class="o">=</span> <span class="p">[</span><span class="n">xmin</span><span class="p">,</span><span class="n">xmax</span><span class="p">,</span><span class="n">ymin</span><span class="p">,</span><span class="n">ymax</span><span class="p">]</span></div>


<div class="viewcode-block" id="Area.setThreshold"><a class="viewcode-back" href="../../Modules.html#PyTrx.Area.Area.setThreshold">[docs]</a>    <span class="k">def</span> <span class="nf">setThreshold</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">number</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Set threshold for number of polgons kept from an image.</span>
<span class="sd">        </span>
<span class="sd">        :param number: Number denoting the number of detected polygons that will be retained</span>
<span class="sd">        :type number: int </span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_threshold</span> <span class="o">=</span> <span class="n">number</span></div>
                                

<div class="viewcode-block" id="Area.setColourrange"><a class="viewcode-back" href="../../Modules.html#PyTrx.Area.Area.setColourrange">[docs]</a>    <span class="k">def</span> <span class="nf">setColourrange</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">upper</span><span class="p">,</span> <span class="n">lower</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Manually define the RBG colour range that will be used to filter</span>
<span class="sd">        the image/images.</span>
<span class="sd">        </span>
<span class="sd">        :param upper: Upper value of colour range</span>
<span class="sd">        :type upper: int</span>
<span class="sd">        :param lower: Lower value of colour range</span>
<span class="sd">        :type lower: int</span>
<span class="sd">        &quot;&quot;&quot;</span>    
        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\n</span><span class="s1">Colour range defined from given values:&#39;</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Upper RBG boundary: &#39;</span><span class="p">,</span> <span class="n">upper</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Lower RBG boundary: &#39;</span><span class="p">,</span> <span class="n">lower</span><span class="p">)</span>
        
        <span class="c1">#Assign colour range</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_colourrange</span> <span class="o">=</span> <span class="p">[</span><span class="n">upper</span><span class="p">,</span> <span class="n">lower</span><span class="p">]</span></div>
        

<div class="viewcode-block" id="Area.setEnhance"><a class="viewcode-back" href="../../Modules.html#PyTrx.Area.Area.setEnhance">[docs]</a>    <span class="k">def</span> <span class="nf">setEnhance</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">diff</span><span class="p">,</span> <span class="n">phi</span><span class="p">,</span> <span class="n">theta</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Set image enhancement parameters. Change brightness and contrast of </span>
<span class="sd">        image using phi and theta variables. Change phi and theta values </span>
<span class="sd">        accordingly. See enhanceImg function for detailed explanation of the </span>
<span class="sd">        parameters.</span>
<span class="sd">        </span>
<span class="sd">        :param diff: Inputted as either &#39;light or &#39;dark&#39;, signifying the intensity of the image pixels. &#39;light&#39; increases the intensity such that dark pixels become much brighter and bright pixels become slightly brighter. &#39;dark&#39; decreases the intensity such that dark pixels become much darker and bright pixels become slightly darker.</span>
<span class="sd">        :type diff: str</span>
<span class="sd">        :param phi: Defines the intensity of all pixel values</span>
<span class="sd">        :type phi: int</span>
<span class="sd">        :param theta: Defines the number of &quot;colours&quot; in the image, e.g. 3 signifies that all the pixels will be grouped into one of three pixel values</span>
<span class="sd">        :type theta: int               .</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_enhance</span> <span class="o">=</span> <span class="n">diff</span><span class="p">,</span> <span class="n">phi</span><span class="p">,</span> <span class="n">theta</span></div></div>
 

<span class="c1">#------------------------------------------------------------------------------   </span>

<div class="viewcode-block" id="calcAutoArea"><a class="viewcode-back" href="../../Modules.html#PyTrx.Area.calcAutoArea">[docs]</a><span class="k">def</span> <span class="nf">calcAutoArea</span><span class="p">(</span><span class="n">img</span><span class="p">,</span> <span class="n">imn</span><span class="p">,</span> <span class="n">colourrange</span><span class="p">,</span> <span class="n">hmatrix</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">threshold</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> 
                 <span class="n">invprojvars</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Detects areas of interest from a given image, and returns pixel and xyz </span>
<span class="sd">    areas along with polygon coordinates. Detection is performed from the image </span>
<span class="sd">    using a predefined RBG colour range. The colour range is then used to </span>
<span class="sd">    extract pixels within that range using the OpenCV function inRange. If a </span>
<span class="sd">    threshold has been set (using the setThreshold function) then only nth </span>
<span class="sd">    polygons will be retained. XYZ areas and polygon coordinates are only </span>
<span class="sd">    calculated when a set of inverse projection variables are provided.</span>
<span class="sd">    </span>
<span class="sd">    :param img: Image array</span>
<span class="sd">    :type img: arr</span>
<span class="sd">    :param imn: Image name</span>
<span class="sd">    :type imn: str</span>
<span class="sd">    :param colourrange: RBG colour range for areas to be detected from</span>
<span class="sd">    :type colourrange: list</span>
<span class="sd">    :param hmatrix: Homography matrix, default to None</span>
<span class="sd">    :type hmatrix: arr</span>
<span class="sd">    :param threshold: Threshold number of detected areas to retain, default to None</span>
<span class="sd">    :type threshold: int, optional</span>
<span class="sd">    :param invprojvars: Inverse projection variables [X,Y,Z,uv0], default to None</span>
<span class="sd">    :type invprojvars: list, optional</span>
<span class="sd">    :returns: Four list items containing 1) the sum of total detected areas (xyz), 2) XYZ coordinates of detected areas, 3) Sum of total detected areas (px), and 4) UV coordinates of detected areas</span>
<span class="sd">    :rtype: list</span>
<span class="sd">    &quot;&quot;&quot;</span>                       
    <span class="c1">#Get upper and lower RBG boundaries from colour range</span>
    <span class="n">upper_boundary</span> <span class="o">=</span> <span class="n">colourrange</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
    <span class="n">lower_boundary</span> <span class="o">=</span> <span class="n">colourrange</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>

    <span class="c1">#Transform RBG range to array    </span>
    <span class="n">upper_boundary</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">upper_boundary</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="s1">&#39;uint8&#39;</span><span class="p">)</span>
    <span class="n">lower_boundary</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">lower_boundary</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="s1">&#39;uint8&#39;</span><span class="p">)</span>

    <span class="c1">#Extract extent based on RBG range</span>
    <span class="n">mask</span> <span class="o">=</span> <span class="n">cv2</span><span class="o">.</span><span class="n">inRange</span><span class="p">(</span><span class="n">img</span><span class="p">,</span> <span class="n">lower_boundary</span><span class="p">,</span> <span class="n">upper_boundary</span><span class="p">)</span>

<span class="c1">#    #Speckle filter to remove noise - needs fixing</span>
<span class="c1">#    mask = cv2.filterSpeckles(mask, 1, 30, 2)</span>

    <span class="c1">#Polygonize extents using OpenCV findContours function        </span>
    <span class="n">polyimg</span><span class="p">,</span> <span class="n">line</span><span class="p">,</span> <span class="n">hier</span> <span class="o">=</span> <span class="n">cv2</span><span class="o">.</span><span class="n">findContours</span><span class="p">(</span><span class="n">mask</span><span class="p">,</span> <span class="n">cv2</span><span class="o">.</span><span class="n">RETR_EXTERNAL</span><span class="p">,</span> 
                                           <span class="n">cv2</span><span class="o">.</span><span class="n">CHAIN_APPROX_NONE</span><span class="p">)</span>
    
    <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\n</span><span class="s1">Detected &#39;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">line</span><span class="p">))</span> <span class="o">+</span> <span class="s1">&#39; regions in &#39;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">imn</span><span class="p">))</span>
    
    <span class="c1">#Append all polygons from the polys list that have more than </span>
    <span class="c1">#a given number of points     </span>
    <span class="n">rawpx</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="n">line</span><span class="p">:</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">c</span><span class="p">)</span> <span class="o">&gt;=</span> <span class="mi">40</span><span class="p">:</span>
            <span class="n">rawpx</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">c</span><span class="p">)</span>
    
    <span class="c1">#If threshold has been set, only keep the nth longest polygons</span>
    <span class="k">if</span> <span class="n">threshold</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">rawpx</span><span class="p">)</span> <span class="o">&gt;=</span> <span class="n">threshold</span><span class="p">:</span>
            <span class="n">rawpx</span><span class="o">.</span><span class="n">sort</span><span class="p">(</span><span class="n">key</span><span class="o">=</span><span class="nb">len</span><span class="p">)</span>
            <span class="n">rawpx</span> <span class="o">=</span> <span class="n">rawpx</span><span class="p">[</span><span class="o">-</span><span class="p">(</span><span class="n">threshold</span><span class="p">):]</span>        

    <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Kept &#39;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">rawpx</span><span class="p">))</span> <span class="o">+</span> <span class="s1">&#39; regions&#39;</span><span class="p">)</span>
    
    <span class="c1">#Calculate homography-corrected pts if desired</span>
    <span class="k">if</span> <span class="n">hmatrix</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Correcting for camera motion&#39;</span><span class="p">)</span>
        <span class="n">pxpts</span><span class="o">=</span><span class="p">[]</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">rawpx</span><span class="p">:</span>
            <span class="n">corr</span> <span class="o">=</span> <span class="n">Velocity</span><span class="o">.</span><span class="n">apply_persp_homographyPts</span><span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="n">hmatrix</span><span class="p">,</span> <span class="n">inverse</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
            <span class="n">pxpts</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">corr</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">pxpts</span><span class="o">=</span><span class="n">rawpx</span>
                
        
    <span class="c1">#Calculate areas</span>
    <span class="n">pxextent</span><span class="o">=</span><span class="p">[]</span>
    <span class="k">for</span> <span class="n">p</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">pxpts</span><span class="p">)):</span> 

        <span class="k">try</span><span class="p">:</span>        
            <span class="c1">#Create geometry</span>
            <span class="n">pxpoly</span><span class="o">=</span><span class="n">getOGRArea</span><span class="p">(</span><span class="n">pxpts</span><span class="p">[</span><span class="n">p</span><span class="p">]</span><span class="o">.</span><span class="n">squeeze</span><span class="p">())</span>
            
            <span class="c1">#Calculate area of polygon area</span>
            <span class="n">pxextent</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">pxpoly</span><span class="o">.</span><span class="n">Area</span><span class="p">())</span>
        
        <span class="c1">#Create zero object if no polygon has been recorded </span>
        <span class="k">except</span><span class="p">:</span>
            <span class="n">pxextent</span> <span class="o">=</span> <span class="mi">0</span>
        
    <span class="nb">print</span> <span class="p">(</span><span class="s1">&#39;Total extent: &#39;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="nb">sum</span><span class="p">(</span><span class="n">pxextent</span><span class="p">))</span> <span class="o">+</span> <span class="s1">&#39; px (out of &#39;</span> 
            <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">img</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">*</span><span class="n">img</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span> <span class="o">+</span> <span class="s1">&#39; px)&#39;</span><span class="p">)</span>  
    
    <span class="c1">#Get xyz coordinates with inverse projection</span>
    <span class="k">if</span> <span class="n">invprojvars</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">xyzpts</span><span class="o">=</span><span class="p">[]</span>
        <span class="n">xyzarea</span><span class="o">=</span><span class="p">[]</span>
        
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">pxpts</span><span class="p">:</span>           
            <span class="c1">#Inverse project points </span>
            <span class="n">proj</span><span class="o">=</span><span class="n">projectUV</span><span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="n">invprojvars</span><span class="p">)</span>           
            <span class="n">xyzpts</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">proj</span><span class="p">)</span>
            
            <span class="c1">#Get areas for xyz polygons</span>
            <span class="n">ogrpol</span> <span class="o">=</span> <span class="n">getOGRArea</span><span class="p">(</span><span class="n">proj</span><span class="p">)</span>                   
            <span class="n">xyzarea</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">ogrpol</span><span class="o">.</span><span class="n">GetArea</span><span class="p">())</span>
            
        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Total area: &#39;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="nb">sum</span><span class="p">(</span><span class="n">xyzarea</span><span class="p">))</span> <span class="o">+</span> <span class="s1">&#39; m&#39;</span><span class="p">)</span>
                
        <span class="c1">#Return XYZ and pixel areas</span>
        <span class="k">return</span> <span class="p">[[</span><span class="n">xyzarea</span><span class="p">,</span> <span class="n">xyzpts</span><span class="p">],</span> <span class="p">[</span><span class="n">pxextent</span><span class="p">,</span> <span class="n">pxpts</span><span class="p">]]</span>
    
    <span class="k">else</span><span class="p">:</span>
        <span class="c1">#Return pixel areas only</span>
        <span class="k">return</span> <span class="p">[[</span><span class="kc">None</span><span class="p">,</span> <span class="kc">None</span><span class="p">],</span> <span class="p">[</span><span class="n">pxextent</span><span class="p">,</span> <span class="n">pxpts</span><span class="p">]]</span></div>
        

<div class="viewcode-block" id="calcManualArea"><a class="viewcode-back" href="../../Modules.html#PyTrx.Area.calcManualArea">[docs]</a><span class="k">def</span> <span class="nf">calcManualArea</span><span class="p">(</span><span class="n">img</span><span class="p">,</span> <span class="n">imn</span><span class="p">,</span> <span class="n">hmatrix</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">pxplot</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">invprojvars</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Manually define an area in a given image. User input is facilitated</span>
<span class="sd">    through an interactive plot to click around the area of interest. XYZ areas</span>
<span class="sd">    are calculated if a set of inverse projection variables are given.</span>
<span class="sd">    </span>
<span class="sd">    :param img: Image array</span>
<span class="sd">    :type img: arr</span>
<span class="sd">    :param imn: Image name</span>
<span class="sd">    :type imn: str</span>
<span class="sd">    :param hmatrix: Homography matrix, default to None</span>
<span class="sd">    :type hmatrix: arr    </span>
<span class="sd">    :param pxplot: Plotting extent for manual area definition, default to None</span>
<span class="sd">    :type pxplot: list, optional</span>
<span class="sd">    :param invprojvars: Inverse projection variables [X,Y,Z,uv0], default to None</span>
<span class="sd">    :type invprojvars: list, optional</span>
<span class="sd">    :returns: Four list items containing 1) the sum of total detected areas (xyz), 2) XYZ coordinates of detected areas, 3) Sum of total detected areas (px), and 4) UV coordinates of detected areas</span>
<span class="sd">    :rtype: list</span>
<span class="sd">    &quot;&quot;&quot;</span>   
    <span class="c1">#Initialise figure window and plot image</span>
    <span class="n">fig</span><span class="o">=</span><span class="n">plt</span><span class="o">.</span><span class="n">gcf</span><span class="p">()</span>
    <span class="n">fig</span><span class="o">.</span><span class="n">canvas</span><span class="o">.</span><span class="n">set_window_title</span><span class="p">(</span><span class="n">imn</span> <span class="o">+</span> <span class="s1">&#39;: Click around region. Press enter &#39;</span>
                                <span class="s1">&#39;to record points.&#39;</span><span class="p">)</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">imshow</span><span class="p">(</span><span class="n">img</span><span class="p">,</span> <span class="n">origin</span><span class="o">=</span><span class="s1">&#39;upper&#39;</span><span class="p">,</span> <span class="n">cmap</span><span class="o">=</span><span class="s1">&#39;gray&#39;</span><span class="p">)</span>
    
    <span class="c1">#Set plotting extent if required</span>
    <span class="k">if</span> <span class="n">pxplot</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">axis</span><span class="p">([</span><span class="n">pxplot</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span><span class="n">pxplot</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span>
                  <span class="n">pxplot</span><span class="p">[</span><span class="mi">2</span><span class="p">],</span><span class="n">pxplot</span><span class="p">[</span><span class="mi">3</span><span class="p">]])</span> 
    
    <span class="c1">#Manual input of points from clicking on plot using pyplot.ginput</span>
    <span class="n">rawpx</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">ginput</span><span class="p">(</span><span class="n">n</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">timeout</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">show_clicks</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">mouse_add</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> 
                       <span class="n">mouse_pop</span><span class="o">=</span><span class="mi">3</span><span class="p">,</span> <span class="n">mouse_stop</span><span class="o">=</span><span class="mi">2</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span> <span class="o">+</span> <span class="n">imn</span> <span class="o">+</span> <span class="s1">&#39;: you clicked &#39;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">rawpx</span><span class="p">))</span> <span class="o">+</span> <span class="s1">&#39; points&#39;</span><span class="p">)</span>
    
    <span class="c1">#Show plot</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>

    <span class="c1">#Convert coordinates to array</span>
    <span class="n">pxpts</span><span class="o">=</span><span class="p">[]</span>
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">rawpx</span><span class="p">:</span>
        <span class="n">pxpts</span><span class="o">.</span><span class="n">append</span><span class="p">([[</span><span class="n">i</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span><span class="n">i</span><span class="p">[</span><span class="mi">1</span><span class="p">]]])</span>
    <span class="n">pxpts</span><span class="o">.</span><span class="n">append</span><span class="p">([[</span><span class="n">rawpx</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">0</span><span class="p">],</span><span class="n">rawpx</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">1</span><span class="p">]]])</span>
    <span class="n">pxpts</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">asarray</span><span class="p">(</span><span class="n">pxpts</span><span class="p">)</span>
    
    <span class="c1">#Calculate homography-corrected pts if desired</span>
    <span class="k">if</span> <span class="n">hmatrix</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Correcting for camera motion&#39;</span><span class="p">)</span>
        <span class="n">pxpts</span> <span class="o">=</span> <span class="n">Velocity</span><span class="o">.</span><span class="n">apply_persp_homographyPts</span><span class="p">(</span><span class="n">pxpts</span><span class="p">,</span> <span class="n">hmatrix</span><span class="p">,</span> 
                                                   <span class="n">inverse</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        
    <span class="c1">#Create polygon if area has been recorded   </span>
    <span class="k">try</span><span class="p">:</span>    
        <span class="c1">#Create geometry</span>
        <span class="n">pxpoly</span><span class="o">=</span><span class="n">getOGRArea</span><span class="p">(</span><span class="n">pxpts</span><span class="o">.</span><span class="n">squeeze</span><span class="p">())</span>
        
        <span class="c1">#Calculate area of polygon area</span>
        <span class="n">pxextent</span> <span class="o">=</span> <span class="n">pxpoly</span><span class="o">.</span><span class="n">Area</span><span class="p">()</span>
    
    <span class="c1">#Create zero object if no polygon has been recorded </span>
    <span class="k">except</span><span class="p">:</span>
        <span class="n">pxextent</span> <span class="o">=</span> <span class="mi">0</span>
    
    <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Total extent: &#39;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">pxextent</span><span class="p">)</span> <span class="o">+</span> <span class="s1">&#39; px (out of &#39;</span> <span class="o">+</span> 
          <span class="nb">str</span><span class="p">(</span><span class="n">img</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">*</span><span class="n">img</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span> <span class="o">+</span> <span class="s1">&#39; px)&#39;</span><span class="p">)</span>    
    
    <span class="c1">#Convert pts list to array</span>
    <span class="n">pxpts</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">pxpts</span><span class="p">)</span>           
    <span class="n">pxpts</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">squeeze</span><span class="p">(</span><span class="n">pxpts</span><span class="p">)</span>
    

    <span class="k">if</span> <span class="n">invprojvars</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="c1">#Get xyz coordinates with inverse projection</span>
        <span class="n">xyzpts</span><span class="o">=</span><span class="n">projectUV</span><span class="p">(</span><span class="n">pxpts</span><span class="p">,</span> <span class="n">invprojvars</span><span class="p">)</span> 
        
        <span class="c1">#Calculate area of xyz polygon</span>
        <span class="n">xyzarea</span> <span class="o">=</span> <span class="n">getOGRArea</span><span class="p">(</span><span class="n">xyzpts</span><span class="p">)</span>                   
        <span class="n">xyzarea</span><span class="o">=</span><span class="n">xyzarea</span><span class="o">.</span><span class="n">GetArea</span><span class="p">()</span>
        
        <span class="c1">#Return XYZ and pixel areas</span>
        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Total area: &#39;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">xyzarea</span><span class="p">)</span> <span class="o">+</span> <span class="s1">&#39; m&#39;</span><span class="p">)</span>
        <span class="k">return</span> <span class="p">[[[</span><span class="n">xyzarea</span><span class="p">],</span> <span class="p">[</span><span class="n">xyzpts</span><span class="p">]],</span> <span class="p">[[</span><span class="n">pxextent</span><span class="p">],</span> <span class="p">[</span><span class="n">pxpts</span><span class="p">]]]</span>

    <span class="c1">#Return pixel areas only    </span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">return</span> <span class="p">[[</span><span class="kc">None</span><span class="p">,</span> <span class="kc">None</span><span class="p">],</span> <span class="p">[</span><span class="n">pxextent</span><span class="p">,</span> <span class="n">pxpts</span><span class="p">]]</span>          </div>


<div class="viewcode-block" id="defineColourrange"><a class="viewcode-back" href="../../Modules.html#PyTrx.Area.defineColourrange">[docs]</a><span class="k">def</span> <span class="nf">defineColourrange</span><span class="p">(</span><span class="n">img</span><span class="p">,</span> <span class="n">imn</span><span class="p">,</span> <span class="n">pxplot</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Define colour range manually by clicking on the lightest and </span>
<span class="sd">    darkest regions of the target extent that will be defined. Plot interaction </span>
<span class="sd">    information: Left click to select, right click to undo selection, close the </span>
<span class="sd">    image window to continue, and the window automatically times out after two </span>
<span class="sd">    clicks.</span>
<span class="sd">    </span>
<span class="sd">    :param img: Image array</span>
<span class="sd">    :type img: arr</span>
<span class="sd">    :param imn: Image name</span>
<span class="sd">    :type imn: str</span>
<span class="sd">    :param pxplot: Plotting extent for manual area definition, default to None</span>
<span class="sd">    :type pxplot: list, optional</span>
<span class="sd">    :returns: List containing the upper and lower boundary for pixel detection</span>
<span class="sd">    :rtype: list</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c1">#Initialise figure window</span>
    <span class="n">fig</span><span class="o">=</span><span class="n">plt</span><span class="o">.</span><span class="n">gcf</span><span class="p">()</span>
    <span class="n">fig</span><span class="o">.</span><span class="n">canvas</span><span class="o">.</span><span class="n">set_window_title</span><span class="p">(</span><span class="n">imn</span> <span class="o">+</span> <span class="s1">&#39;: Click lightest colour and darkest&#39;</span> 
                                <span class="s1">&#39; colour&#39;</span><span class="p">)</span>
    
    <span class="c1">#Plot image</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">imshow</span><span class="p">(</span><span class="n">img</span><span class="p">,</span> <span class="n">origin</span><span class="o">=</span><span class="s1">&#39;upper&#39;</span><span class="p">)</span>
    
    <span class="c1">#Define plotting extent if required</span>
    <span class="k">if</span> <span class="n">pxplot</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">axis</span><span class="p">([</span><span class="n">pxplot</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span><span class="n">pxplot</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span><span class="n">pxplot</span><span class="p">[</span><span class="mi">2</span><span class="p">],</span><span class="n">pxplot</span><span class="p">[</span><span class="mi">3</span><span class="p">]])</span>

    <span class="c1">#Manually interact to select lightest and darkest part of the region            </span>
    <span class="n">colours</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">ginput</span><span class="p">(</span><span class="n">n</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span> <span class="n">timeout</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">show_clicks</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">mouse_add</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> 
                        <span class="n">mouse_pop</span><span class="o">=</span><span class="mi">3</span><span class="p">,</span> <span class="n">mouse_stop</span><span class="o">=</span><span class="mi">2</span><span class="p">)</span>
    
    <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span> <span class="o">+</span> <span class="n">imn</span> <span class="o">+</span> <span class="s1">&#39;: you clicked &#39;</span> <span class="o">+</span> <span class="n">colours</span><span class="p">)</span>
    
    <span class="c1">#Show plot</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
    
    <span class="c1">#Get pixel intensity value for pt1       </span>
    <span class="n">col1_rbg</span> <span class="o">=</span> <span class="n">img</span><span class="p">[</span><span class="n">colours</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">1</span><span class="p">],</span><span class="n">colours</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">0</span><span class="p">]]</span>
    <span class="k">if</span> <span class="n">col1_rbg</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
        <span class="n">col1_rbg</span><span class="o">=</span><span class="mi">1</span>

    <span class="c1">#Get pixel intensity value for pt2        </span>
    <span class="n">col2_rbg</span> <span class="o">=</span> <span class="n">img</span><span class="p">[</span><span class="n">colours</span><span class="p">[</span><span class="mi">1</span><span class="p">][</span><span class="mi">1</span><span class="p">],</span><span class="n">colours</span><span class="p">[</span><span class="mi">1</span><span class="p">][</span><span class="mi">0</span><span class="p">]]</span>
    <span class="k">if</span> <span class="n">col2_rbg</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
        <span class="n">col2_rbg</span><span class="o">=</span><span class="mi">1</span>
        
    <span class="c1">#Assign RBG range based on value of the chosen RBG values</span>
    <span class="k">if</span> <span class="n">col1_rbg</span> <span class="o">&gt;</span> <span class="n">col2_rbg</span><span class="p">:</span>
        <span class="n">upper_boundary</span> <span class="o">=</span> <span class="n">col1_rbg</span>
        <span class="n">lower_boundary</span> <span class="o">=</span> <span class="n">col2_rbg</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">upper_boundary</span> <span class="o">=</span> <span class="n">col2_rbg</span>
        <span class="n">lower_boundary</span> <span class="o">=</span> <span class="n">col1_rbg</span>
    
    <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\n</span><span class="s1">Colour range found from manual selection&#39;</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Upper RBG boundary: &#39;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">upper_boundary</span><span class="p">))</span>
    <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Lower RBG boundary: &#39;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">lower_boundary</span><span class="p">))</span>

    <span class="c1">#Return RBG range</span>
    <span class="k">return</span> <span class="p">[</span><span class="n">upper_boundary</span><span class="p">,</span> <span class="n">lower_boundary</span><span class="p">]</span></div>
   
    
<div class="viewcode-block" id="getOGRArea"><a class="viewcode-back" href="../../Modules.html#PyTrx.Area.getOGRArea">[docs]</a><span class="k">def</span> <span class="nf">getOGRArea</span><span class="p">(</span><span class="n">pts</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Get real world OGR polygons (.shp) from xyz poly pts with real world </span>
<span class="sd">    points which are compatible with mapping software (e.g. ArcGIS).</span>

<span class="sd">    :param pts: UV/XYZ coordinates of a given area shape</span>
<span class="sd">    :type pts: arr </span>
<span class="sd">    :returns: List of OGR geometry polygons</span>
<span class="sd">    :rtype: list                           </span>
<span class="sd">    &quot;&quot;&quot;</span>                      
    <span class="c1">#Create geometries from uv/xyz coordinates using ogr                     </span>
    <span class="n">ring</span> <span class="o">=</span> <span class="n">ogr</span><span class="o">.</span><span class="n">Geometry</span><span class="p">(</span><span class="n">ogr</span><span class="o">.</span><span class="n">wkbLinearRing</span><span class="p">)</span>
    <span class="k">for</span> <span class="n">p</span> <span class="ow">in</span> <span class="n">pts</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">np</span><span class="o">.</span><span class="n">isnan</span><span class="p">(</span><span class="n">p</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span> <span class="o">==</span> <span class="kc">False</span><span class="p">:</span>
            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">p</span><span class="p">)</span><span class="o">==</span><span class="mi">2</span><span class="p">:</span>
                <span class="n">ring</span><span class="o">.</span><span class="n">AddPoint</span><span class="p">(</span><span class="nb">int</span><span class="p">(</span><span class="n">p</span><span class="p">[</span><span class="mi">0</span><span class="p">]),</span><span class="nb">int</span><span class="p">(</span><span class="n">p</span><span class="p">[</span><span class="mi">1</span><span class="p">]))</span>
            <span class="k">else</span><span class="p">:</span>                  
                <span class="n">ring</span><span class="o">.</span><span class="n">AddPoint</span><span class="p">(</span><span class="n">p</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span><span class="n">p</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span><span class="n">p</span><span class="p">[</span><span class="mi">2</span><span class="p">])</span>
    <span class="n">poly</span> <span class="o">=</span> <span class="n">ogr</span><span class="o">.</span><span class="n">Geometry</span><span class="p">(</span><span class="n">ogr</span><span class="o">.</span><span class="n">wkbPolygon</span><span class="p">)</span>
    <span class="n">poly</span><span class="o">.</span><span class="n">AddGeometry</span><span class="p">(</span><span class="n">ring</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">poly</span></div>
</pre></div>

          </div>
        </div>
      </div>
      <div class="sphinxsidebar" role="navigation" aria-label="main navigation">
        <div class="sphinxsidebarwrapper">
<div id="searchbox" style="display: none" role="search">
  <h3 id="searchlabel">Quick search</h3>
    <div class="searchformwrapper">
    <form class="search" action="../../search.html" method="get">
      <input type="text" name="q" aria-labelledby="searchlabel" />
      <input type="submit" value="Go" />
    </form>
    </div>
</div>
<script type="text/javascript">$('#searchbox').show(0);</script>
        </div>
      </div>
      <div class="clearer"></div>
    </div>
    <div class="related" role="navigation" aria-label="related navigation">
      <h3>Navigation</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="../../genindex.html" title="General Index"
             >index</a></li>
        <li class="right" >
          <a href="../../py-modindex.html" title="Python Module Index"
             >modules</a> |</li>
        <li class="nav-item nav-item-0"><a href="../../index.html">PyTrx 1.1.0 documentation</a> &#187;</li>
          <li class="nav-item nav-item-1"><a href="../index.html" >Module code</a> &#187;</li> 
      </ul>
    </div>
    <div class="footer" role="contentinfo">
        &#169; Copyright 2020, Penelope How, Nick Hulton, Lynne Buie.
      Created using <a href="http://sphinx-doc.org/">Sphinx</a> 2.2.0.
    </div>
  </body>
</html>