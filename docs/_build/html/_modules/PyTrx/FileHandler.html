
<!DOCTYPE html>

<html xmlns="http://www.w3.org/1999/xhtml">
  <head>
    <meta charset="utf-8" />
    <title>PyTrx.FileHandler &#8212; PyTrx 1.1.0 documentation</title>
    <link rel="stylesheet" href="../../_static/classic.css" type="text/css" />
    <link rel="stylesheet" href="../../_static/pygments.css" type="text/css" />
    
    <script type="text/javascript" id="documentation_options" data-url_root="../../" src="../../_static/documentation_options.js"></script>
    <script type="text/javascript" src="../../_static/jquery.js"></script>
    <script type="text/javascript" src="../../_static/underscore.js"></script>
    <script type="text/javascript" src="../../_static/doctools.js"></script>
    <script type="text/javascript" src="../../_static/language_data.js"></script>
    
    <link rel="index" title="Index" href="../../genindex.html" />
    <link rel="search" title="Search" href="../../search.html" /> 
  </head><body>
    <div class="related" role="navigation" aria-label="related navigation">
      <h3>Navigation</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="../../genindex.html" title="General Index"
             accesskey="I">index</a></li>
        <li class="right" >
          <a href="../../py-modindex.html" title="Python Module Index"
             >modules</a> |</li>
        <li class="nav-item nav-item-0"><a href="../../index.html">PyTrx 1.1.0 documentation</a> &#187;</li>
          <li class="nav-item nav-item-1"><a href="../index.html" accesskey="U">Module code</a> &#187;</li> 
      </ul>
    </div>  

    <div class="document">
      <div class="documentwrapper">
        <div class="bodywrapper">
          <div class="body" role="main">
            
  <h1>Source code for PyTrx.FileHandler</h1><div class="highlight"><pre>
<span></span>
<span class="c1">#PyTrx (c) by Penelope How, Nick Hulton, Lynne Buie</span>
<span class="c1">#</span>
<span class="c1">#PyTrx is licensed under a MIT License.</span>
<span class="c1">#</span>
<span class="c1">#You should have received a copy of the license along with this</span>
<span class="c1">#work. If not, see &lt;https://choosealicense.com/licenses/mit/&gt;.</span>

<span class="sd">&#39;&#39;&#39;</span>
<span class="sd">Th FileHandler module contains all the functions called by a PyTrx object to </span>
<span class="sd">load and export data.</span>
<span class="sd">&#39;&#39;&#39;</span>

<span class="c1">#Import packages</span>
<span class="kn">from</span> <span class="nn">PIL</span> <span class="k">import</span> <span class="n">Image</span><span class="p">,</span> <span class="n">ImageDraw</span>
<span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>
<span class="kn">import</span> <span class="nn">operator</span>
<span class="kn">import</span> <span class="nn">matplotlib.pyplot</span> <span class="k">as</span> <span class="nn">plt</span>
<span class="kn">import</span> <span class="nn">scipy.io</span> <span class="k">as</span> <span class="nn">sio</span>
<span class="kn">from</span> <span class="nn">osgeo</span> <span class="k">import</span> <span class="n">ogr</span><span class="p">,</span><span class="n">osr</span>
<span class="kn">import</span> <span class="nn">os</span>
<span class="kn">from</span> <span class="nn">functools</span> <span class="k">import</span> <span class="n">reduce</span>

<span class="c1">#------------------------------------------------------------------------------   </span>

<div class="viewcode-block" id="readMask"><a class="viewcode-back" href="../../Modules.html#PyTrx.FileHandler.readMask">[docs]</a><span class="k">def</span> <span class="nf">readMask</span><span class="p">(</span><span class="n">img</span><span class="p">,</span> <span class="n">writeMask</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
    <span class="sd">&#39;&#39;&#39;Function to create a mask for point seeding using PIL to rasterize </span>
<span class="sd">    polygon. The mask is manually defined by the user using the pyplot ginput </span>
<span class="sd">    function. This subsequently returns the manually defined area as a .jpg </span>
<span class="sd">    mask.     </span>
<span class="sd">    The writeMask file path is used to either open the existing mask at that </span>
<span class="sd">    path or to write the generated mask to this path.</span>
<span class="sd">    </span>
<span class="sd">    :param img: Image to define mask in</span>
<span class="sd">    :type img: arr</span>
<span class="sd">    :param writeMask: File destination that mask output is written to, default</span>
<span class="sd">to None</span>
<span class="sd">    :type writeMask: str, optional</span>
<span class="sd">    :returns: Array defining the image mask</span>
<span class="sd">    :rtype: arr      </span>
<span class="sd">    &#39;&#39;&#39;</span>
    <span class="c1">#Check if a mask already exists, if not enter digitising</span>
    <span class="k">if</span> <span class="n">writeMask</span><span class="o">!=</span><span class="kc">None</span><span class="p">:</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">myMask</span> <span class="o">=</span> <span class="n">Image</span><span class="o">.</span><span class="n">open</span><span class="p">(</span><span class="n">writeMask</span><span class="p">)</span>
            <span class="n">myMask</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">myMask</span><span class="p">)</span>
            <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\n</span><span class="s1">Image mask loaded&#39;</span><span class="p">)</span>
            <span class="k">return</span> <span class="n">myMask</span>
        <span class="k">except</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\n</span><span class="s1">Mask file not found. Proceeding to manually digitise...&#39;</span><span class="p">)</span>

    <span class="c1">#Plot mask manually on the selected image</span>
    <span class="n">fig</span><span class="o">=</span><span class="n">plt</span><span class="o">.</span><span class="n">gcf</span><span class="p">()</span>
    <span class="n">fig</span><span class="o">.</span><span class="n">canvas</span><span class="o">.</span><span class="n">set_window_title</span><span class="p">(</span><span class="s1">&#39;Click to create mask. Press enter to record&#39;</span> 
                                <span class="s1">&#39; points.&#39;</span><span class="p">)</span>
    <span class="n">imgplot</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">imshow</span><span class="p">(</span><span class="n">img</span><span class="p">,</span> <span class="n">origin</span><span class="o">=</span><span class="s1">&#39;upper&#39;</span><span class="p">)</span>
    <span class="n">imgplot</span><span class="o">.</span><span class="n">set_cmap</span><span class="p">(</span><span class="s1">&#39;gray&#39;</span><span class="p">)</span>
    <span class="n">x1</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">ginput</span><span class="p">(</span><span class="n">n</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">timeout</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">show_clicks</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">mouse_add</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">mouse_pop</span><span class="o">=</span><span class="mi">3</span><span class="p">,</span> 
                    <span class="n">mouse_stop</span><span class="o">=</span><span class="mi">2</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">x1</span><span class="p">))</span> <span class="o">+</span> <span class="s1">&#39; points seeded&#39;</span><span class="p">)</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
    
    <span class="c1">#Close shape</span>
    <span class="n">x1</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">x1</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
    
    <span class="c1">#Generate polygon</span>
    <span class="n">ring</span> <span class="o">=</span> <span class="n">ogr</span><span class="o">.</span><span class="n">Geometry</span><span class="p">(</span><span class="n">ogr</span><span class="o">.</span><span class="n">wkbLinearRing</span><span class="p">)</span>
    <span class="k">for</span> <span class="n">p</span> <span class="ow">in</span> <span class="n">x1</span><span class="p">:</span>
        <span class="n">ring</span><span class="o">.</span><span class="n">AddPoint</span><span class="p">(</span><span class="n">p</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span><span class="n">p</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>
    <span class="n">p</span><span class="o">=</span><span class="n">x1</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
    <span class="n">ring</span><span class="o">.</span><span class="n">AddPoint</span><span class="p">(</span><span class="n">p</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span><span class="n">p</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>    
    <span class="n">poly</span> <span class="o">=</span> <span class="n">ogr</span><span class="o">.</span><span class="n">Geometry</span><span class="p">(</span><span class="n">ogr</span><span class="o">.</span><span class="n">wkbPolygon</span><span class="p">)</span>
    <span class="n">poly</span><span class="o">.</span><span class="n">AddGeometry</span><span class="p">(</span><span class="n">ring</span><span class="p">)</span>
     
    <span class="c1">#Rasterize polygon using PIL</span>
    <span class="n">height</span> <span class="o">=</span> <span class="n">img</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
    <span class="n">width</span> <span class="o">=</span> <span class="n">img</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
    <span class="n">img1</span> <span class="o">=</span> <span class="n">Image</span><span class="o">.</span><span class="n">new</span><span class="p">(</span><span class="s1">&#39;L&#39;</span><span class="p">,</span> <span class="p">(</span><span class="n">width</span><span class="p">,</span><span class="n">height</span><span class="p">),</span> <span class="mi">0</span><span class="p">)</span>
    <span class="n">draw</span><span class="o">=</span><span class="n">ImageDraw</span><span class="o">.</span><span class="n">Draw</span><span class="p">(</span><span class="n">img1</span><span class="p">)</span>
    <span class="n">draw</span><span class="o">.</span><span class="n">polygon</span><span class="p">(</span><span class="n">x1</span><span class="p">,</span> <span class="n">outline</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">fill</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
    <span class="n">myMask</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">img1</span><span class="p">)</span>
    
    <span class="c1">#Write to .jpg file    </span>
    <span class="k">if</span> <span class="n">writeMask</span><span class="o">!=</span><span class="kc">None</span><span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\n</span><span class="s1">Mask plotted: &#39;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">writeMask</span><span class="p">))</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">img1</span><span class="o">.</span><span class="n">save</span><span class="p">(</span><span class="n">writeMask</span><span class="p">,</span> <span class="n">quality</span><span class="o">=</span><span class="mi">75</span><span class="p">)</span>
        <span class="k">except</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\n</span><span class="s1">Failed to write file: &#39;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">writeMask</span><span class="p">))</span>
        
    <span class="k">return</span> <span class="n">myMask</span>  </div>


<div class="viewcode-block" id="readCalib"><a class="viewcode-back" href="../../Modules.html#PyTrx.FileHandler.readCalib">[docs]</a><span class="k">def</span> <span class="nf">readCalib</span><span class="p">(</span><span class="n">fileName</span><span class="p">,</span> <span class="n">paramList</span><span class="p">):</span>
    <span class="sd">&#39;&#39;&#39;Function to find camera calibrations from a file given a list or </span>
<span class="sd">    Matlab file containing the required parameters. Returns the parameters as a</span>
<span class="sd">    dictionary object.</span>
<span class="sd">    Compatible file structures:</span>
<span class="sd">    .txt file:   &quot;RadialDistortion [k1,k2,k3...k8]</span>
<span class="sd">                 TangentialDistortion [p1,p2]</span>
<span class="sd">                 IntrinsicMatrix [fx 0. 0.][s fy 0.][cx cy 1]</span>
<span class="sd">                 End&quot;</span>
<span class="sd">    .mat file:   Camera calibration file output from the Matlab Camera </span>
<span class="sd">                 Calibration App (available in the Computer Vision Systems </span>
<span class="sd">                 toolbox).</span>
<span class="sd">    </span>
<span class="sd">    :param fileName: File directory for calibration file</span>
<span class="sd">    :type fileName: str    </span>
<span class="sd">    :param paramList: List of strings denoting keywords to look for in </span>
<span class="sd">calibration file</span>
<span class="sd">    :type paramList: list       </span>
<span class="sd">    :returns: Calibration parameters denoted by keywords</span>
<span class="sd">    :rtype: list    </span>
<span class="sd">    &#39;&#39;&#39;</span>    
    <span class="c1">#Load as text file if txt format</span>
    <span class="k">if</span> <span class="n">fileName</span><span class="p">[</span><span class="o">-</span><span class="mi">3</span><span class="p">:]</span> <span class="o">==</span> <span class="s1">&#39;txt&#39;</span><span class="p">:</span>            
        <span class="c1">#Open file</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">myFile</span><span class="o">=</span><span class="nb">open</span><span class="p">(</span><span class="n">fileName</span><span class="p">,</span><span class="s1">&#39;r&#39;</span><span class="p">)</span>
        <span class="k">except</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\n</span><span class="s1">Problem opening calibration text file: &#39;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">fileName</span><span class="p">))</span>
            <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;No calibration parameters successfully read&#39;</span><span class="p">)</span>
            <span class="k">return</span> <span class="kc">None</span>
        
        <span class="c1">#Read lines in file</span>
        <span class="n">lines</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">line</span> <span class="ow">in</span> <span class="n">myFile</span><span class="o">.</span><span class="n">readlines</span><span class="p">():</span>
            <span class="n">lines</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">line</span><span class="p">[</span><span class="mi">0</span><span class="p">:</span><span class="o">-</span><span class="mi">1</span><span class="p">])</span> 
                
        <span class="c1">#Set up a dictionary and input the calibration parameters </span>
        <span class="n">calib</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="k">for</span> <span class="n">p</span> <span class="ow">in</span> <span class="n">paramList</span><span class="p">:</span>
            <span class="n">dataLines</span><span class="o">=</span> <span class="n">lineSearch</span><span class="p">(</span><span class="n">lines</span><span class="p">,</span> <span class="n">p</span><span class="p">)</span>
            <span class="n">data</span> <span class="o">=</span> <span class="n">returnData</span><span class="p">(</span><span class="n">lines</span><span class="p">,</span> <span class="n">dataLines</span><span class="p">)</span>
            <span class="n">param</span> <span class="o">=</span> <span class="p">{}</span>
            <span class="n">param</span><span class="p">[</span><span class="n">p</span><span class="p">]</span> <span class="o">=</span> <span class="n">data</span>
            <span class="n">calib</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">param</span><span class="p">)</span>        
        <span class="k">return</span> <span class="n">calib</span>
    
    <span class="c1">#Load as matlab file if mat format</span>
    <span class="k">elif</span> <span class="n">fileName</span><span class="p">[</span><span class="o">-</span><span class="mi">3</span><span class="p">:]</span> <span class="o">==</span> <span class="s1">&#39;mat&#39;</span><span class="p">:</span>            
        <span class="c1">#Get the Matlab file as a dictionary</span>
        <span class="n">mat</span> <span class="o">=</span> <span class="n">sio</span><span class="o">.</span><span class="n">loadmat</span><span class="p">(</span><span class="n">fileName</span><span class="p">)</span>
           
        <span class="c1"># Get desired keys from the dictionary</span>
        <span class="n">calib</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">([(</span><span class="n">i</span><span class="p">,</span> <span class="n">mat</span><span class="p">[</span><span class="n">i</span><span class="p">])</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">paramList</span> <span class="k">if</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">mat</span><span class="p">])</span>
        <span class="k">return</span> <span class="n">calib</span>
   
    <span class="c1">#Incompatible file types     </span>
    <span class="k">else</span><span class="p">:</span>
        <span class="nb">print</span> <span class="p">(</span><span class="s1">&#39;</span><span class="se">\n</span><span class="s1">You have specified an incorrect calibration file type&#39;</span>
               <span class="s1">&#39;</span><span class="se">\n</span><span class="s1">Acceptable file types are .txt and .mat.&#39;</span><span class="p">)</span></div>


<div class="viewcode-block" id="lineSearch"><a class="viewcode-back" href="../../Modules.html#PyTrx.FileHandler.lineSearch">[docs]</a><span class="k">def</span> <span class="nf">lineSearch</span><span class="p">(</span><span class="n">lineList</span><span class="p">,</span> <span class="n">search</span><span class="p">):</span>
    <span class="sd">&#39;&#39;&#39;Function to supplement the readCalib function. Given an input parameter </span>
<span class="sd">    to search within the file, this will return the line numbers of the data.</span>
<span class="sd">    </span>
<span class="sd">    :param lineList: List of strings within a file line</span>
<span class="sd">    :type lineList: list        </span>
<span class="sd">    :param search: Target keyword to search for</span>
<span class="sd">    :type search: str</span>
<span class="sd">    :returns:  Line numbers with keyword match</span>
<span class="sd">    :rtype: list      </span>
<span class="sd">    &#39;&#39;&#39;</span>
    <span class="c1">#Find line matching the parameter</span>
    <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">line</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">lineList</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">search</span> <span class="ow">in</span> <span class="n">line</span><span class="p">:</span> 
            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">search</span><span class="p">)</span> <span class="o">==</span> <span class="nb">len</span><span class="p">(</span><span class="n">lineList</span><span class="p">[</span><span class="n">i</span><span class="p">]):</span>
                <span class="n">match</span> <span class="o">=</span> <span class="n">i</span>
    
    <span class="c1">#Find lines containing the associated data        </span>
    <span class="n">dataLines</span><span class="o">=</span><span class="p">[]</span>
    <span class="n">atEnd</span><span class="o">=</span><span class="kc">False</span>
    <span class="n">match</span> <span class="o">+=</span> <span class="mi">1</span>
    <span class="k">while</span> <span class="ow">not</span><span class="p">(</span><span class="n">atEnd</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">lineList</span><span class="p">[</span><span class="n">match</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">isupper</span><span class="p">()</span> <span class="ow">or</span> <span class="n">lineList</span><span class="p">[</span><span class="n">match</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;_&#39;</span><span class="p">:</span>
            <span class="n">atEnd</span><span class="o">=</span><span class="kc">True</span>
        <span class="k">else</span><span class="p">:</span> 
            <span class="n">dataLines</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">match</span><span class="p">)</span>
            <span class="n">match</span> <span class="o">+=</span> <span class="mi">1</span>
            
    <span class="k">return</span> <span class="n">dataLines</span></div>


<div class="viewcode-block" id="returnData"><a class="viewcode-back" href="../../Modules.html#PyTrx.FileHandler.returnData">[docs]</a><span class="k">def</span> <span class="nf">returnData</span><span class="p">(</span><span class="n">lines</span><span class="p">,</span> <span class="n">data</span><span class="p">):</span>
    <span class="sd">&#39;&#39;&#39;Function to supplement the importCalibration function. Given the line </span>
<span class="sd">    numbers of the parameter data (the ouput of the lineSearch function), this </span>
<span class="sd">    will return the data.</span>
<span class="sd">    </span>
<span class="sd">    :param lines: Given line numbers to extract data from</span>
<span class="sd">    :type lines: list</span>
<span class="sd">    :param data: Raw line data</span>
<span class="sd">    :type data: list        </span>
<span class="sd">    :returns: Extracted data</span>
<span class="sd">    :rtype: arr</span>
<span class="sd">    &#39;&#39;&#39;</span>    
    <span class="c1">#Create empty list for output data</span>
    <span class="n">D</span><span class="o">=</span><span class="p">[]</span>
    
    <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">data</span><span class="p">:</span>
                
        <span class="c1"># Find the fields on each line</span>
        <span class="n">fields</span> <span class="o">=</span> <span class="n">lines</span><span class="p">[</span><span class="n">x</span><span class="p">]</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">&#39;[&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">&#39;]&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">)</span>
        <span class="n">fields</span><span class="o">=</span><span class="n">fields</span><span class="o">.</span><span class="n">split</span><span class="p">()</span>
        
        <span class="n">d</span> <span class="o">=</span> <span class="p">[]</span>
        
        <span class="c1">#Float all values</span>
        <span class="k">for</span> <span class="n">f</span> <span class="ow">in</span> <span class="n">fields</span><span class="p">:</span>
            <span class="n">d</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="nb">float</span><span class="p">(</span><span class="n">f</span><span class="p">))</span>
                            
        <span class="c1"># Add the fields to the data list</span>
        <span class="n">D</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">d</span><span class="p">)</span>

    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">D</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
        <span class="n">D</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">D</span><span class="p">)</span>
    
    <span class="k">return</span> <span class="n">D</span></div>


<div class="viewcode-block" id="readMatrixDistortion"><a class="viewcode-back" href="../../Modules.html#PyTrx.FileHandler.readMatrixDistortion">[docs]</a><span class="k">def</span> <span class="nf">readMatrixDistortion</span><span class="p">(</span><span class="n">path</span><span class="p">):</span>
    <span class="sd">&#39;&#39;&#39;Function to support the calibrate function. Returns the </span>
<span class="sd">    intrinsic matrix and distortion parameters required for calibration from a</span>
<span class="sd">    given file.</span>
<span class="sd">    </span>
<span class="sd">    :param path: Directory of calibration file</span>
<span class="sd">    :type path: str</span>
<span class="sd">    :returns: Three camera matrix parameters: 1) the intrinsic matrix as a 3x3 </span>
<span class="sd">array, including focal length, principal point, and skew (arr); 2) Tangential </span>
<span class="sd">distortion values (p1, p2) (arr); and 3) Radial distortion values </span>
<span class="sd">(k1, k2... k6)</span>
<span class="sd">    :rtype: arr</span>
<span class="sd">    &#39;&#39;&#39;</span>   
    <span class="c1">#Find the calibration parameters from the list</span>
    <span class="n">ls</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;IntrinsicMatrix&#39;</span><span class="p">,</span> <span class="s1">&#39;RadialDistortion&#39;</span><span class="p">,</span> <span class="s1">&#39;TangentialDistortion&#39;</span><span class="p">]</span>
    <span class="n">calibDict</span> <span class="o">=</span> <span class="n">readCalib</span><span class="p">(</span><span class="n">path</span><span class="p">,</span> <span class="n">ls</span><span class="p">)</span>
    
    <span class="c1">#Stop if there is an issue in reading calibration file    </span>
    <span class="k">if</span> <span class="n">calibDict</span><span class="o">==</span><span class="kc">None</span><span class="p">:</span>
        <span class="k">return</span> <span class="kc">None</span>   

    <span class="c1">#Set calibration parameters in the correct format    </span>
    <span class="n">intrMat</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">calibDict</span><span class="p">[</span><span class="s2">&quot;IntrinsicMatrix&quot;</span><span class="p">])</span> <span class="c1">#fx,fy,s,cx,cy</span>
    <span class="n">radDis</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">calibDict</span><span class="p">[</span><span class="s2">&quot;RadialDistortion&quot;</span><span class="p">])</span> <span class="c1"># k1-k6</span>
    <span class="n">tanDis</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">calibDict</span><span class="p">[</span><span class="s2">&quot;TangentialDistortion&quot;</span><span class="p">])</span> <span class="c1"># p1,p2</span>
   
    <span class="k">return</span> <span class="n">intrMat</span><span class="p">,</span> <span class="n">tanDis</span><span class="p">,</span> <span class="n">radDis</span></div>


<div class="viewcode-block" id="checkMatrix"><a class="viewcode-back" href="../../Modules.html#PyTrx.FileHandler.checkMatrix">[docs]</a><span class="k">def</span> <span class="nf">checkMatrix</span><span class="p">(</span><span class="n">matrix</span><span class="p">):</span>
    <span class="sd">&#39;&#39;&#39;Function to support the calibrate function. Checks and converts the </span>
<span class="sd">    intrinsic matrix to the correct format for calibration with OpenCV.</span>
<span class="sd">    </span>
<span class="sd">    :param matrix: Inputted matrix for checking</span>
<span class="sd">    :type matrix: arr</span>
<span class="sd">    :returns: Validated matrix</span>
<span class="sd">    :rtype: arr          </span>
<span class="sd">    &#39;&#39;&#39;</span>  
    <span class="c1"># Transpose if zeros in matrix are not in correct places</span>
    <span class="k">if</span> <span class="n">matrix</span><span class="p">[</span><span class="mi">2</span><span class="p">,</span><span class="mi">0</span><span class="p">]</span><span class="o">!=</span><span class="mi">0</span> <span class="ow">and</span> <span class="n">matrix</span><span class="p">[</span><span class="mi">2</span><span class="p">,</span><span class="mi">1</span><span class="p">]</span><span class="o">!=</span><span class="mi">0</span> <span class="ow">and</span> <span class="n">matrix</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span><span class="mi">2</span><span class="p">]</span><span class="o">==</span><span class="mi">0</span> <span class="ow">and</span> <span class="n">matrix</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span><span class="mi">2</span><span class="p">]</span><span class="o">==</span><span class="mi">0</span><span class="p">:</span>
        <span class="n">mat</span> <span class="o">=</span> <span class="n">matrix</span><span class="o">.</span><span class="n">transpose</span><span class="p">()</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">mat</span> <span class="o">=</span> <span class="n">matrix</span>
     
    <span class="c1"># Set 0&#39;s and 1&#39;s in the correct locations</span>
    <span class="n">it</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="mi">0</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">2</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">2</span><span class="p">,</span><span class="mi">1</span><span class="p">])</span>     
    <span class="n">it</span><span class="o">.</span><span class="n">shape</span><span class="o">=</span><span class="p">(</span><span class="mi">4</span><span class="p">,</span><span class="mi">2</span><span class="p">)</span>
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">4</span><span class="p">):</span>
        <span class="n">x</span> <span class="o">=</span> <span class="n">it</span><span class="p">[</span><span class="n">i</span><span class="p">,</span><span class="mi">0</span><span class="p">]</span>
        <span class="n">y</span> <span class="o">=</span> <span class="n">it</span><span class="p">[</span><span class="n">i</span><span class="p">,</span><span class="mi">1</span><span class="p">]</span>
        <span class="n">mat</span><span class="p">[</span><span class="n">x</span><span class="p">,</span><span class="n">y</span><span class="p">]</span><span class="o">=</span><span class="mi">0</span>        
    <span class="n">mat</span><span class="p">[</span><span class="mi">2</span><span class="p">,</span><span class="mi">2</span><span class="p">]</span><span class="o">=</span><span class="mi">1</span> 

    <span class="k">return</span> <span class="n">mat</span></div>


<div class="viewcode-block" id="readImg"><a class="viewcode-back" href="../../Modules.html#PyTrx.FileHandler.readImg">[docs]</a><span class="k">def</span> <span class="nf">readImg</span><span class="p">(</span><span class="n">path</span><span class="p">,</span> <span class="n">band</span><span class="o">=</span><span class="s1">&#39;L&#39;</span><span class="p">,</span> <span class="n">equal</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>
    <span class="sd">&#39;&#39;&#39;Function to prepare an image by opening, equalising, converting to </span>
<span class="sd">    either grayscale or a specified band, then returning a copy.</span>

<span class="sd">    :param path: Image file path directory</span>
<span class="sd">    :type path: str</span>
<span class="sd">    :param band: Desired band output - &#39;R&#39;: red band; &#39;B&#39;: blue band; &#39;G&#39;: </span>
<span class="sd">green band; &#39;L&#39;: grayscale (default).</span>
<span class="sd">    :type band: str </span>
<span class="sd">    :param equal: Flag to denote if histogram equalisation should be applied,</span>
<span class="sd">defaults to True</span>
<span class="sd">    :type equal: bool    </span>
<span class="sd">    :returns: Image array</span>
<span class="sd">    :rtype: arr</span>
<span class="sd">    &#39;&#39;&#39;</span>   
    <span class="c1"># Open image file</span>
    <span class="n">band</span><span class="o">=</span><span class="n">band</span><span class="o">.</span><span class="n">upper</span><span class="p">()</span>
    <span class="n">im</span><span class="o">=</span><span class="n">Image</span><span class="o">.</span><span class="n">open</span><span class="p">(</span><span class="n">path</span><span class="p">)</span>
    
    <span class="c1">#Equalise histogram</span>
    <span class="k">if</span> <span class="n">equal</span> <span class="ow">is</span> <span class="kc">True</span><span class="p">:</span>
        <span class="n">h</span> <span class="o">=</span> <span class="n">im</span><span class="o">.</span><span class="n">convert</span><span class="p">(</span><span class="s2">&quot;L&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">histogram</span><span class="p">()</span>
        <span class="n">lut</span> <span class="o">=</span> <span class="p">[]</span>
    
        <span class="k">for</span> <span class="n">b</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">h</span><span class="p">),</span> <span class="mi">256</span><span class="p">):</span>
    
            <span class="c1">#Step size</span>
            <span class="n">step</span> <span class="o">=</span> <span class="n">reduce</span><span class="p">(</span><span class="n">operator</span><span class="o">.</span><span class="n">add</span><span class="p">,</span> <span class="n">h</span><span class="p">[</span><span class="n">b</span><span class="p">:</span><span class="n">b</span><span class="o">+</span><span class="mi">256</span><span class="p">])</span> <span class="o">/</span> <span class="mi">255</span>
    
            <span class="c1">#Create equalization lookup table</span>
            <span class="n">n</span> <span class="o">=</span> <span class="mi">0</span>
            <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">256</span><span class="p">):</span>
                <span class="n">lut</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">n</span> <span class="o">/</span> <span class="n">step</span><span class="p">)</span>
                <span class="n">n</span> <span class="o">=</span> <span class="n">n</span> <span class="o">+</span> <span class="n">h</span><span class="p">[</span><span class="n">i</span><span class="o">+</span><span class="n">b</span><span class="p">]</span>
        
        <span class="c1">#Convert to grayscale</span>
        <span class="n">gray</span> <span class="o">=</span> <span class="n">im</span><span class="o">.</span><span class="n">point</span><span class="p">(</span><span class="n">lut</span><span class="o">*</span><span class="n">im</span><span class="o">.</span><span class="n">layers</span><span class="p">)</span>    
    <span class="k">else</span><span class="p">:</span>
        <span class="n">gray</span><span class="o">=</span><span class="n">im</span>
    
    <span class="c1">#Split bands if R, B or G is specified in inputs    </span>
    <span class="k">if</span> <span class="n">band</span><span class="o">==</span><span class="s1">&#39;R&#39;</span><span class="p">:</span>
        <span class="n">gray</span><span class="p">,</span><span class="n">g</span><span class="p">,</span><span class="n">b</span><span class="o">=</span><span class="n">gray</span><span class="o">.</span><span class="n">split</span><span class="p">()</span>
    <span class="k">elif</span> <span class="n">band</span><span class="o">==</span><span class="s1">&#39;G&#39;</span><span class="p">:</span>
        <span class="n">r</span><span class="p">,</span><span class="n">gray</span><span class="p">,</span><span class="n">b</span><span class="o">=</span><span class="n">gray</span><span class="o">.</span><span class="n">split</span><span class="p">()</span> 
    <span class="k">elif</span> <span class="n">band</span><span class="o">==</span><span class="s1">&#39;B&#39;</span><span class="p">:</span>
        <span class="n">r</span><span class="p">,</span><span class="n">g</span><span class="p">,</span><span class="n">gray</span><span class="o">=</span><span class="n">gray</span><span class="o">.</span><span class="n">split</span><span class="p">()</span> 
    <span class="k">else</span><span class="p">:</span>
        <span class="n">gray</span> <span class="o">=</span> <span class="n">gray</span><span class="o">.</span><span class="n">convert</span><span class="p">(</span><span class="s1">&#39;L&#39;</span><span class="p">)</span>
    
    <span class="c1">#Copy and return image    </span>
    <span class="n">bw</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">gray</span><span class="p">)</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
    
    <span class="k">return</span> <span class="n">bw</span></div>


<div class="viewcode-block" id="readGCPs"><a class="viewcode-back" href="../../Modules.html#PyTrx.FileHandler.readGCPs">[docs]</a><span class="k">def</span> <span class="nf">readGCPs</span><span class="p">(</span><span class="n">fileName</span><span class="p">):</span>
    <span class="sd">&#39;&#39;&#39;Function to read ground control points from a .txt file. The data in the</span>
<span class="sd">    file is referenced to under a header line. Data is appended by skipping the</span>
<span class="sd">    header line and finding the world and image coordinates from each line.</span>
<span class="sd">    </span>
<span class="sd">    :param fileName: File path directory for GCP file</span>
<span class="sd">    :type fileName: str</span>
<span class="sd">    :returns: Two arrays containing the GCPs in xyz coordinates, and the GCPs</span>
<span class="sd">in image coordinates</span>
<span class="sd">    :rtype: array    </span>
<span class="sd">    &#39;&#39;&#39;</span>    
    <span class="c1"># Open the file and read the first line (i.e. the header line)</span>
    <span class="n">myFile</span><span class="o">=</span><span class="nb">open</span><span class="p">(</span><span class="n">fileName</span><span class="p">,</span><span class="s1">&#39;r&#39;</span><span class="p">)</span>  
    <span class="n">myFile</span><span class="o">.</span><span class="n">readline</span><span class="p">()</span>

    <span class="c1">#Iterate through lines and append to lists</span>
    <span class="n">gcps</span><span class="o">=</span> <span class="p">[]</span>
    <span class="n">count</span><span class="o">=</span><span class="mi">2</span>
    <span class="k">for</span> <span class="n">line</span> <span class="ow">in</span> <span class="n">myFile</span><span class="o">.</span><span class="n">readlines</span><span class="p">():</span>  
        <span class="n">items</span><span class="o">=</span><span class="n">line</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\t</span><span class="s1">&#39;</span><span class="p">)</span>
        <span class="n">gcp</span> <span class="o">=</span> <span class="p">[]</span>
        
        <span class="c1">#Append values if they are valid</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">items</span><span class="p">:</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">gcp</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="nb">float</span><span class="p">(</span><span class="n">i</span><span class="p">))</span> 
            <span class="k">except</span> <span class="ne">ValueError</span><span class="p">:</span>
                <span class="k">pass</span>
        
        <span class="c1">#Append points if there are 5 corresponding values</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">gcp</span><span class="p">)</span><span class="o">==</span><span class="mi">5</span><span class="p">:</span>    
            <span class="n">gcps</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">gcp</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="nb">print</span> <span class="p">(</span><span class="s1">&#39;</span><span class="se">\n</span><span class="s1">GCP file line &#39;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">count</span><span class="p">)</span> <span class="o">+</span> <span class="s1">&#39; not passed forward&#39;</span><span class="p">)</span>
        
        <span class="c1">#Update counter        </span>
        <span class="n">count</span><span class="o">=</span><span class="n">count</span><span class="o">+</span><span class="mi">1</span>
                  
    <span class="c1">#Split the list into world and image coordinates</span>
    <span class="n">gcparray</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">gcps</span><span class="p">)</span>
    <span class="n">world</span><span class="p">,</span> <span class="n">image</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">hsplit</span><span class="p">(</span><span class="n">gcparray</span><span class="p">,</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="mi">3</span><span class="p">]))</span>
           
    <span class="k">return</span> <span class="n">world</span><span class="p">,</span> <span class="n">image</span></div>

    
<div class="viewcode-block" id="writeCalibFile"><a class="viewcode-back" href="../../Modules.html#PyTrx.FileHandler.writeCalibFile">[docs]</a><span class="k">def</span> <span class="nf">writeCalibFile</span><span class="p">(</span><span class="n">intrMat</span><span class="p">,</span> <span class="n">tanDis</span><span class="p">,</span> <span class="n">radDis</span><span class="p">,</span> <span class="n">fname</span><span class="p">):</span>
    <span class="sd">&#39;&#39;&#39;Write camera calibration data to .txt file, including camera matrix, and </span>
<span class="sd">    radial and tangential distortion parameters. </span>

<span class="sd">    :param intrMat: Intrinsic camera matrix</span>
<span class="sd">    :type intrMat: arr </span>
<span class="sd">    :param tanDis: Tangential distortion parameters</span>
<span class="sd">    :type tanDis: arr </span>
<span class="sd">    :param radDis: Radial distortion parameters</span>
<span class="sd">    :type radDis: arr           </span>
<span class="sd">    :param fname: Directory to write file to</span>
<span class="sd">    :type fname: str            </span>
<span class="sd">    &#39;&#39;&#39;</span>         
    <span class="c1">#Write camera calibration variables to text file</span>
    <span class="n">f</span><span class="o">=</span><span class="nb">open</span><span class="p">(</span><span class="n">fname</span><span class="p">,</span><span class="s1">&#39;w&#39;</span><span class="p">)</span>                            
    <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s1">&#39;RadialDistortion&#39;</span> <span class="o">+</span> <span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">radDis</span><span class="p">)</span> <span class="o">+</span> <span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span> <span class="o">+</span>
            <span class="s1">&#39;TangentialDistortion&#39;</span> <span class="o">+</span> <span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">tanDis</span><span class="p">)</span> <span class="o">+</span> <span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span> <span class="o">+</span>
            <span class="s1">&#39;IntrinsicMatrix&#39;</span> <span class="o">+</span> <span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">intrMat</span><span class="p">)</span> <span class="o">+</span> <span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span> <span class="o">+</span>
            <span class="s1">&#39;End&#39;</span><span class="p">)</span></div>
            

<div class="viewcode-block" id="writeVeloFile"><a class="viewcode-back" href="../../Modules.html#PyTrx.FileHandler.writeVeloFile">[docs]</a><span class="k">def</span> <span class="nf">writeVeloFile</span><span class="p">(</span><span class="n">xyzvel</span><span class="p">,</span> <span class="n">uvvel</span><span class="p">,</span> <span class="n">homog</span><span class="p">,</span> <span class="n">imn</span><span class="p">,</span> <span class="n">fname</span><span class="p">):</span>
    <span class="sd">&#39;&#39;&#39;Function to write all velocity data from a given timeLapse sequence to </span>
<span class="sd">    .csv file. Data is formatted as sequential columns containing the following</span>
<span class="sd">    information: Image pair 1 name, Image pair 2 name, Average xyz velocity,</span>
<span class="sd">    Number of features tracked, Average pixel velocity, Homography residual </span>
<span class="sd">    mean error (RMS), and Signal-to-noise ratio.</span>
<span class="sd">         </span>
<span class="sd">    :param xyzvel: XYZ velocities</span>
<span class="sd">    :type xyzvel: list</span>
<span class="sd">    :param uvvel: Pixel velocities</span>
<span class="sd">    :type uvvel: list</span>
<span class="sd">    :param homog: Homography [mtx, im0pts, im1pts, ptserr, homogerr]</span>
<span class="sd">    :type homog: list </span>
<span class="sd">    :param imn: List of image names</span>
<span class="sd">    :param imn: list</span>
<span class="sd">    :param fname: Filename for output file. File destination can also specified</span>
<span class="sd">    :type fname: str</span>
<span class="sd">    &#39;&#39;&#39;</span>        
    <span class="c1">#Initialise file writing</span>
    <span class="n">f</span><span class="o">=</span><span class="nb">open</span><span class="p">(</span><span class="n">fname</span><span class="p">,</span><span class="s1">&#39;w&#39;</span><span class="p">)</span>

    <span class="c1">#Assign first image in pair</span>
    <span class="n">fn1</span><span class="o">=</span><span class="n">imn</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
    
    <span class="c1">#Define column headers</span>
    <span class="n">header</span><span class="o">=</span><span class="p">(</span><span class="s1">&#39;Image 0, Image 1, Average xyz velocity, Features tracked, &#39;</span>
            <span class="s1">&#39;Average px velocity, Homography RMS Error, SNR&#39;</span><span class="p">)</span>    
    <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">header</span> <span class="o">+</span> <span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span>

    <span class="c1">#Iterate through timeLapse object</span>
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">xyzvel</span><span class="p">)):</span>
        
        <span class="c1">#Re-define image0 for each iteration</span>
        <span class="n">fn0</span><span class="o">=</span><span class="n">fn1</span>
        
        <span class="c1">#Get image1</span>
        <span class="n">fn1</span><span class="o">=</span><span class="n">imn</span><span class="p">[</span><span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="p">]</span>
               
        <span class="c1">#Get velocity data                     </span>
        <span class="n">xyz</span> <span class="o">=</span> <span class="n">xyzvel</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
        <span class="n">uv</span> <span class="o">=</span> <span class="n">uvvel</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
        
        <span class="c1">#Calculate average xyz and px velocities</span>
        <span class="n">xyzvelav</span> <span class="o">=</span> <span class="nb">sum</span><span class="p">(</span><span class="n">xyz</span><span class="p">)</span><span class="o">/</span><span class="nb">len</span><span class="p">(</span><span class="n">xyz</span><span class="p">)</span>
        <span class="n">uvvelav</span> <span class="o">=</span> <span class="nb">sum</span><span class="p">(</span><span class="n">uv</span><span class="p">)</span><span class="o">/</span><span class="nb">len</span><span class="p">(</span><span class="n">uv</span><span class="p">)</span>
        
        <span class="c1">#Write average xyzvel, number of features tracked, and uvvel</span>
        <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">fn0</span><span class="p">)</span> <span class="o">+</span> <span class="s1">&#39;,&#39;</span><span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">fn1</span><span class="p">)</span> <span class="o">+</span> <span class="s1">&#39;,&#39;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">xyzvelav</span><span class="p">)</span> <span class="o">+</span> <span class="s1">&#39;,&#39;</span> 
                <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">xyz</span><span class="p">))</span> <span class="o">+</span> <span class="s1">&#39;,&#39;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">uvvelav</span><span class="p">)</span> <span class="o">+</span> <span class="s1">&#39;,&#39;</span><span class="p">)</span>
                     
        <span class="c1">#Get homography information if desired</span>
        <span class="k">if</span> <span class="n">homog</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">hpt0</span> <span class="o">=</span> <span class="n">homog</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="mi">1</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span>
            <span class="n">hpt1</span> <span class="o">=</span> <span class="n">homog</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="mi">1</span><span class="p">][</span><span class="mi">1</span><span class="p">]</span>
            <span class="n">hpt1corr</span> <span class="o">=</span> <span class="n">homog</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="mi">1</span><span class="p">][</span><span class="mi">2</span><span class="p">]</span>
            <span class="n">herr</span> <span class="o">=</span> <span class="n">homog</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="mi">3</span><span class="p">]</span>
    
            <span class="c1">#Get xyz homography errors                      </span>
            <span class="n">xd</span><span class="o">=</span><span class="n">herr</span><span class="p">[</span><span class="mi">1</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span>
            <span class="n">yd</span><span class="o">=</span><span class="n">herr</span><span class="p">[</span><span class="mi">1</span><span class="p">][</span><span class="mi">1</span><span class="p">]</span>
            
            <span class="c1">#Get uv point positions                </span>
            <span class="n">psx</span><span class="o">=</span><span class="n">hpt0</span><span class="p">[:,</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">]</span>
            <span class="n">psy</span><span class="o">=</span><span class="n">hpt0</span><span class="p">[:,</span><span class="mi">0</span><span class="p">,</span><span class="mi">1</span><span class="p">]</span>
            
            <span class="k">if</span> <span class="n">hpt1corr</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">pfx</span><span class="o">=</span><span class="n">hpt1corr</span><span class="p">[:,</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">]</span>
                <span class="n">pfy</span><span class="o">=</span><span class="n">hpt1corr</span><span class="p">[:,</span><span class="mi">0</span><span class="p">,</span><span class="mi">1</span><span class="p">]</span> 
            <span class="k">else</span><span class="p">:</span>                   
                <span class="n">pfx</span><span class="o">=</span><span class="n">hpt1</span><span class="p">[:,</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">]</span>
                <span class="n">pfy</span><span class="o">=</span><span class="n">hpt1</span><span class="p">[:,</span><span class="mi">0</span><span class="p">,</span><span class="mi">1</span><span class="p">]</span>    
                
            <span class="c1">#Determine uv point position difference</span>
            <span class="n">pdx</span><span class="o">=</span><span class="n">pfx</span><span class="o">-</span><span class="n">psx</span>
            <span class="n">pdy</span><span class="o">=</span><span class="n">pfy</span><span class="o">-</span><span class="n">psy</span>
            
            <span class="c1">#Calculate homography and homography error            </span>
            <span class="n">homogdist</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">pdx</span><span class="o">*</span><span class="n">pdx</span><span class="o">+</span><span class="n">pdy</span><span class="o">*</span><span class="n">pdy</span><span class="p">)</span>
            <span class="n">errdist</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">xd</span><span class="o">*</span><span class="n">xd</span><span class="o">+</span><span class="n">yd</span><span class="o">*</span><span class="n">yd</span><span class="p">)</span>
            
            <span class="c1">#Calculate mean homography and mean error </span>
            <span class="n">meanerrdist</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">errdist</span><span class="p">)</span>
            
            <span class="c1">#Write pixel velocity, mean homog error, and SNR (pxvel/err)</span>
            <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">meanerrdist</span><span class="p">)</span> <span class="o">+</span> <span class="s1">&#39;,&#39;</span>  <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">meanerrdist</span><span class="o">/</span><span class="n">uvvelav</span><span class="p">))</span>

        <span class="k">else</span><span class="p">:</span>
            <span class="c1">#Write pixel velocity and NaN homography information</span>
            <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s1">&#39;NaN, NaN&#39;</span><span class="p">)</span>
                         
        <span class="c1">#Break line in output file</span>
        <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span>
            
    <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\n</span><span class="s1">Velocity file written:&#39;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">fname</span><span class="p">))</span>        </div>
        
   
<div class="viewcode-block" id="writeHomogFile"><a class="viewcode-back" href="../../Modules.html#PyTrx.FileHandler.writeHomogFile">[docs]</a><span class="k">def</span> <span class="nf">writeHomogFile</span><span class="p">(</span><span class="n">homog</span><span class="p">,</span> <span class="n">imn</span><span class="p">,</span> <span class="n">fname</span><span class="p">):</span>
    <span class="sd">&#39;&#39;&#39;Function to write all homography data from a given timeLapse sequence to </span>
<span class="sd">    .csv file. Data is formatted as sequential columns containing the following </span>
<span class="sd">    information: Image pair 1 name, Image pair 2 name, Homography matrix (i.e. </span>
<span class="sd">    all values in the 3x3 matrix), Number of features tracked, X mean </span>
<span class="sd">    displacement, Y mean displacement, X standard deviation, Y standard </span>
<span class="sd">    deviation, Mean error magnitude, Mean homographic displacement, and </span>
<span class="sd">    Signal-to-noise ratio.</span>
<span class="sd">    </span>
<span class="sd">    :param homog: Homography [mtx, im0pts, im1pts, ptserr, homogerr]</span>
<span class="sd">    :type homog: list</span>
<span class="sd">    :param imn: List of image names</span>
<span class="sd">    :type imn: list </span>
<span class="sd">    :param fname: Directory for file to be written to</span>
<span class="sd">    :type fname: str </span>
<span class="sd">    &#39;&#39;&#39;</span>
    <span class="c1">#Initialise file writing</span>
    <span class="n">f</span><span class="o">=</span><span class="nb">open</span><span class="p">(</span><span class="n">fname</span><span class="p">,</span><span class="s1">&#39;w&#39;</span><span class="p">)</span>
    
    <span class="c1">#Write active directory to file</span>
    <span class="n">fn1</span><span class="o">=</span><span class="n">imn</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
    
    <span class="c1">#Define column headers</span>
    <span class="n">header</span><span class="o">=</span><span class="p">(</span><span class="s1">&#39;Image 0,Image 1,&quot;Homography Matrix[0,0]&quot;,&quot;[0,1]&quot;,&quot;[0,2]&quot;,&#39;</span>
            <span class="s1">&#39;&quot;[1,0]&quot;,&quot;[1,1]&quot;,&quot;[1,2]&quot;,&quot;[2,0]&quot;,&quot;[2,1]&quot;,&quot;[2,2]&quot;,Features Tracked,&#39;</span>
            <span class="s1">&#39;xmean,ymean,xsd,ysd,Mean Error Magnitude,&#39;</span>
            <span class="s1">&#39;Mean Homographic displacement,Homography SNR&#39;</span><span class="p">)</span>  
    
    <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">header</span><span class="o">+</span><span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span>

    <span class="c1">#Iterate through timeLapse object</span>
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">homog</span><span class="p">)):</span>
        
        <span class="c1">#Re-define image0 for each iteration</span>
        <span class="n">fn0</span><span class="o">=</span><span class="n">fn1</span>
        
        <span class="c1">#Get image1</span>
        <span class="n">fn1</span><span class="o">=</span><span class="n">imn</span><span class="p">[</span><span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="p">]</span>

        <span class="c1">#Write image file names to file        </span>
        <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">fn0</span> <span class="o">+</span> <span class="s1">&#39;,&#39;</span> <span class="o">+</span> <span class="n">fn1</span> <span class="o">+</span> <span class="s1">&#39;,&#39;</span><span class="p">)</span>
        
        <span class="c1">#Get homography info</span>
        <span class="n">hmatrix</span> <span class="o">=</span> <span class="n">homog</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span>               <span class="c1">#Homography matrix</span>
        <span class="n">hpt0</span> <span class="o">=</span> <span class="n">homog</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="mi">1</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span>               <span class="c1">#Seeded pts in im0</span>
        <span class="n">hpt1</span> <span class="o">=</span> <span class="n">homog</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="mi">1</span><span class="p">][</span><span class="mi">1</span><span class="p">]</span>               <span class="c1">#Tracked pts in im1</span>
        <span class="n">hpt1corr</span> <span class="o">=</span> <span class="n">homog</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="mi">1</span><span class="p">][</span><span class="mi">2</span><span class="p">]</span>           <span class="c1">#Corrected pts im1</span>
        <span class="n">herr</span> <span class="o">=</span> <span class="n">homog</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="mi">3</span><span class="p">]</span>                  <span class="c1">#Homography error</span>
        
        <span class="c1">#Define output homography matrix</span>
        <span class="k">if</span> <span class="n">hmatrix</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">hmatrix</span><span class="o">.</span><span class="n">shape</span><span class="o">=</span><span class="p">(</span><span class="mi">9</span><span class="p">)</span>
            <span class="k">for</span> <span class="n">val</span> <span class="ow">in</span> <span class="n">hmatrix</span><span class="p">:</span>
                <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">val</span><span class="p">)</span> <span class="o">+</span> <span class="s1">&#39;,&#39;</span><span class="p">)</span>
                
        <span class="c1">#Get xyz homography errors</span>
        <span class="n">xd</span> <span class="o">=</span> <span class="n">herr</span><span class="p">[</span><span class="mi">1</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span>
        <span class="n">yd</span> <span class="o">=</span> <span class="n">herr</span><span class="p">[</span><span class="mi">1</span><span class="p">][</span><span class="mi">1</span><span class="p">]</span> 
        
        <span class="c1">#Get uv point positions</span>
        <span class="n">psx</span> <span class="o">=</span> <span class="n">hpt0</span><span class="p">[:,</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">]</span>
        <span class="n">psy</span> <span class="o">=</span> <span class="n">hpt0</span><span class="p">[:,</span><span class="mi">0</span><span class="p">,</span><span class="mi">1</span><span class="p">]</span>
        
        <span class="k">if</span> <span class="n">hpt1corr</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">pfx</span> <span class="o">=</span> <span class="n">hpt1</span><span class="p">[:,</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">]</span>
            <span class="n">pfy</span> <span class="o">=</span> <span class="n">hpt1</span><span class="p">[:,</span><span class="mi">0</span><span class="p">,</span><span class="mi">1</span><span class="p">]</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">pfx</span> <span class="o">=</span> <span class="n">hpt1corr</span><span class="p">[:,</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">]</span>
            <span class="n">pfy</span> <span class="o">=</span> <span class="n">hpt1corr</span><span class="p">[:,</span><span class="mi">0</span><span class="p">,</span><span class="mi">1</span><span class="p">]</span>
        
        <span class="c1">#Determine uv point position difference</span>
        <span class="n">pdx</span><span class="o">=</span><span class="n">pfx</span><span class="o">-</span><span class="n">psx</span>
        <span class="n">pdy</span><span class="o">=</span><span class="n">pfy</span><span class="o">-</span><span class="n">psy</span>
        
        <span class="c1">#Calculate signal-to-noise ratio            </span>
        <span class="n">errdist</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">xd</span><span class="o">*</span><span class="n">xd</span><span class="o">+</span><span class="n">yd</span><span class="o">*</span><span class="n">yd</span><span class="p">)</span>
        <span class="n">homogdist</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">pdx</span><span class="o">*</span><span class="n">pdx</span><span class="o">+</span><span class="n">pdy</span><span class="o">*</span><span class="n">pdy</span><span class="p">)</span>
        <span class="n">sn</span><span class="o">=</span><span class="n">errdist</span><span class="o">/</span><span class="n">homogdist</span>
        
        <span class="c1">#Determine number of points tracked in homography calculations</span>
        <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">hpt0</span><span class="p">))</span> <span class="o">+</span> <span class="s1">&#39;,&#39;</span><span class="p">)</span>
        
        <span class="c1">#Define output homography matrix errors</span>
        <span class="k">for</span> <span class="n">val</span> <span class="ow">in</span> <span class="n">herr</span><span class="p">[</span><span class="mi">0</span><span class="p">]:</span>
            <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">val</span><span class="p">)</span> <span class="o">+</span> <span class="s1">&#39;,&#39;</span><span class="p">)</span>
        
        <span class="c1">#Compile all data for output file</span>
        <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">errdist</span><span class="p">))</span> <span class="o">+</span> <span class="s1">&#39;,&#39;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">homogdist</span><span class="p">))</span> <span class="o">+</span> <span class="s1">&#39;,&#39;</span> <span class="o">+</span> 
                <span class="nb">str</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">sn</span><span class="p">))</span> <span class="o">+</span> <span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span>
        
    <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\n</span><span class="s1">Homography file written&#39;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">fname</span><span class="p">))</span></div>


<div class="viewcode-block" id="writeAreaFile"><a class="viewcode-back" href="../../Modules.html#PyTrx.FileHandler.writeAreaFile">[docs]</a><span class="k">def</span> <span class="nf">writeAreaFile</span><span class="p">(</span><span class="n">pxareas</span><span class="p">,</span> <span class="n">xyzareas</span><span class="p">,</span> <span class="n">imn</span><span class="p">,</span> <span class="n">destination</span><span class="p">):</span>
    <span class="sd">&#39;&#39;&#39;Write UV and XYZ areas to csv file.</span>

<span class="sd">    :param pxarea: Pixel extents</span>
<span class="sd">    :type pxarea: list</span>
<span class="sd">    :param xyzarea: XYZ areas</span>
<span class="sd">    :type xyzarea: list</span>
<span class="sd">    :param imn: Image names</span>
<span class="sd">    :type imn: list</span>
<span class="sd">    :param destination: File directory where csv file will be written to</span>
<span class="sd">    :type destination: str</span>
<span class="sd">    &#39;&#39;&#39;</span> 
    <span class="c1">#Create file location</span>
    <span class="n">f</span> <span class="o">=</span> <span class="nb">open</span><span class="p">(</span><span class="n">destination</span><span class="p">,</span> <span class="s1">&#39;w&#39;</span><span class="p">)</span>
    
    <span class="c1">#Write data headers</span>
    <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s1">&#39;Image,UV area,XYZ area </span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span>    
     
    <span class="c1">#Write image name, pixel area, and xyz area data     </span>
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">imn</span><span class="p">)):</span>
        <span class="k">if</span> <span class="n">xyzareas</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">imn</span><span class="p">[</span><span class="n">i</span><span class="p">])</span> <span class="o">+</span> <span class="s1">&#39;,&#39;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="nb">sum</span><span class="p">(</span><span class="n">pxareas</span><span class="p">[</span><span class="n">i</span><span class="p">]))</span> <span class="o">+</span> <span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">imn</span><span class="p">[</span><span class="n">i</span><span class="p">])</span> <span class="o">+</span> <span class="s1">&#39;,&#39;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="nb">sum</span><span class="p">(</span><span class="n">pxareas</span><span class="p">[</span><span class="n">i</span><span class="p">]))</span> <span class="o">+</span> <span class="s1">&#39;,&#39;</span> 
                    <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="nb">sum</span><span class="p">(</span><span class="n">xyzareas</span><span class="p">[</span><span class="n">i</span><span class="p">]))</span> <span class="o">+</span> <span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span></div>
            

<div class="viewcode-block" id="writeAreaCoords"><a class="viewcode-back" href="../../Modules.html#PyTrx.FileHandler.writeAreaCoords">[docs]</a><span class="k">def</span> <span class="nf">writeAreaCoords</span><span class="p">(</span><span class="n">pxpts</span><span class="p">,</span> <span class="n">xyzpts</span><span class="p">,</span> <span class="n">imn</span><span class="p">,</span> <span class="n">pxdestination</span><span class="p">,</span> <span class="n">xyzdestination</span><span class="p">):</span>
    <span class="sd">&#39;&#39;&#39;Write UV and XYZ area coordinates to text files. These file types are </span>
<span class="sd">    compatible with the importing tools (importAreaPX, importAreaXYZ).</span>

<span class="sd">    :param xyzarea: XYZ areas</span>
<span class="sd">    :type xyzarea: list</span>
<span class="sd">    :param xyzpts: XYZ coordinates</span>
<span class="sd">    :type xyzpts: list</span>
<span class="sd">    :param imn: Image names</span>
<span class="sd">    :type imn: list</span>
<span class="sd">    :param pxdestination: File directory where UV coordinates will be written to</span>
<span class="sd">    :type pxdestination: str</span>
<span class="sd">    :param xyzdestination: File directory where XYZ coordinates will be written </span>
<span class="sd">to</span>
<span class="sd">    :type xyzdestination: str</span>
<span class="sd">    &#39;&#39;&#39;</span>     
    <span class="c1">#Pixel cooridnates of all pixel extents</span>
    <span class="k">if</span> <span class="n">pxpts</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>       
        <span class="n">f</span> <span class="o">=</span> <span class="nb">open</span><span class="p">(</span><span class="n">pxdestination</span><span class="p">,</span> <span class="s1">&#39;w&#39;</span><span class="p">)</span>
        <span class="n">polycount</span><span class="o">=</span><span class="mi">1</span>        
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">pxpts</span><span class="p">)):</span>
            <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s1">&#39;Img &#39;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">imn</span><span class="p">[</span><span class="n">i</span><span class="p">])</span> <span class="o">+</span> <span class="s1">&#39;</span><span class="se">\t</span><span class="s1">&#39;</span><span class="p">)</span>                
            <span class="k">for</span> <span class="n">pol</span> <span class="ow">in</span> <span class="n">pxpts</span><span class="p">[</span><span class="n">i</span><span class="p">]:</span>
                <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s1">&#39;Poly&#39;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">polycount</span><span class="p">)</span> <span class="o">+</span> <span class="s1">&#39;</span><span class="se">\t</span><span class="s1">&#39;</span><span class="p">)</span>                    
                <span class="k">for</span> <span class="n">pts</span> <span class="ow">in</span> <span class="n">pol</span><span class="p">:</span>
                    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">pts</span><span class="p">)</span><span class="o">==</span><span class="mi">1</span><span class="p">:</span>
                        <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">pts</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">0</span><span class="p">])</span> <span class="o">+</span> <span class="s1">&#39;</span><span class="se">\t</span><span class="s1">&#39;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">pts</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">1</span><span class="p">])</span> <span class="o">+</span> <span class="s1">&#39;</span><span class="se">\t</span><span class="s1">&#39;</span><span class="p">)</span>
                    <span class="k">elif</span> <span class="nb">len</span><span class="p">(</span><span class="n">pts</span><span class="p">)</span><span class="o">==</span><span class="mi">2</span><span class="p">:</span>
                        <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">pts</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span> <span class="o">+</span> <span class="s1">&#39;</span><span class="se">\t</span><span class="s1">&#39;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">pts</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span> <span class="o">+</span> <span class="s1">&#39;</span><span class="se">\t</span><span class="s1">&#39;</span><span class="p">)</span>
                <span class="n">polycount</span> <span class="o">=</span> <span class="n">polycount</span><span class="o">+</span><span class="mi">1</span>
            <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\n\n</span><span class="s1">&#39;</span><span class="p">)</span>
            <span class="n">polycount</span><span class="o">=</span><span class="mi">1</span>

    <span class="c1">#XYZ coordinates of polygons</span>
    <span class="k">if</span> <span class="n">xyzpts</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>                               
        <span class="n">polycount</span><span class="o">=</span><span class="mi">1</span>  
        <span class="n">f</span> <span class="o">=</span> <span class="nb">open</span><span class="p">(</span><span class="n">xyzdestination</span><span class="p">,</span> <span class="s1">&#39;w&#39;</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">xyzpts</span><span class="p">)):</span>                
            <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s1">&#39;Img &#39;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">imn</span><span class="p">[</span><span class="n">i</span><span class="p">])</span> <span class="o">+</span> <span class="s1">&#39;</span><span class="se">\t</span><span class="s1">&#39;</span><span class="p">)</span>
            <span class="k">for</span> <span class="n">pol</span> <span class="ow">in</span> <span class="n">xyzpts</span><span class="p">[</span><span class="n">i</span><span class="p">]:</span>
                <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s1">&#39;Poly&#39;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">polycount</span><span class="p">)</span> <span class="o">+</span> <span class="s1">&#39;</span><span class="se">\t</span><span class="s1">&#39;</span><span class="p">)</span>
                <span class="k">for</span> <span class="n">pts</span> <span class="ow">in</span> <span class="n">pol</span><span class="p">:</span>
                    <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">pts</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span> <span class="o">+</span> <span class="s1">&#39;</span><span class="se">\t</span><span class="s1">&#39;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">pts</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span> <span class="o">+</span> <span class="s1">&#39;</span><span class="se">\t</span><span class="s1">&#39;</span> <span class="o">+</span> 
                            <span class="nb">str</span><span class="p">(</span><span class="n">pts</span><span class="p">[</span><span class="mi">2</span><span class="p">])</span> <span class="o">+</span> <span class="s1">&#39;</span><span class="se">\t</span><span class="s1">&#39;</span><span class="p">)</span>
                <span class="n">polycount</span><span class="o">=</span><span class="n">polycount</span><span class="o">+</span><span class="mi">1</span>
            <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\n\n</span><span class="s1">&#39;</span><span class="p">)</span>
            <span class="n">polycount</span><span class="o">=</span><span class="mi">1</span></div>
                                        

<div class="viewcode-block" id="writeLineFile"><a class="viewcode-back" href="../../Modules.html#PyTrx.FileHandler.writeLineFile">[docs]</a><span class="k">def</span> <span class="nf">writeLineFile</span><span class="p">(</span><span class="n">pxline</span><span class="p">,</span> <span class="n">xyzline</span><span class="p">,</span> <span class="n">imn</span><span class="p">,</span> <span class="n">destination</span><span class="p">):</span>
    <span class="sd">&#39;&#39;&#39;Write UV and XYZ line lengths to csv file.</span>

<span class="sd">    :param pxline: Pixel line lengths</span>
<span class="sd">    :type pxline: list   </span>
<span class="sd">    :param xyzline: XYZ line lengths</span>
<span class="sd">    :type xyzline: list</span>
<span class="sd">    :param imn: Image names</span>
<span class="sd">    :type imn: list</span>
<span class="sd">    :param destination: File directory where output will be written to </span>
<span class="sd">    :type destination: str</span>
<span class="sd">    &#39;&#39;&#39;</span>
    <span class="c1">#Create file</span>
    <span class="n">f</span> <span class="o">=</span> <span class="nb">open</span><span class="p">(</span><span class="n">destination</span><span class="p">,</span> <span class="s1">&#39;w&#39;</span><span class="p">)</span>
    
    <span class="c1">#Write file headers</span>
    <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s1">&#39;Image, UV length, XYZ length </span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span>            
        
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">pxline</span><span class="p">)):</span>
        <span class="k">if</span> <span class="n">xyzline</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">imn</span><span class="p">[</span><span class="n">i</span><span class="p">])</span> <span class="o">+</span> <span class="s1">&#39;,&#39;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">pxline</span><span class="p">[</span><span class="n">i</span><span class="p">])</span> <span class="o">+</span> <span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">imn</span><span class="p">[</span><span class="n">i</span><span class="p">])</span> <span class="o">+</span> <span class="s1">&#39;,&#39;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">pxline</span><span class="p">[</span><span class="n">i</span><span class="p">])</span> <span class="o">+</span> <span class="s1">&#39;,&#39;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">xyzline</span><span class="p">[</span><span class="n">i</span><span class="p">])</span> 
                    <span class="o">+</span> <span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span></div>
    

<div class="viewcode-block" id="writeLineCoords"><a class="viewcode-back" href="../../Modules.html#PyTrx.FileHandler.writeLineCoords">[docs]</a><span class="k">def</span> <span class="nf">writeLineCoords</span><span class="p">(</span><span class="n">uvpts</span><span class="p">,</span> <span class="n">xyzpts</span><span class="p">,</span> <span class="n">imn</span><span class="p">,</span> <span class="n">pxdestination</span><span class="p">,</span> <span class="n">xyzdestination</span><span class="p">):</span>
    <span class="sd">&#39;&#39;&#39;Write UV and XYZ line coordinates to text file. These file types are </span>
<span class="sd">    compatible with the importing tools (importLinePX, importLineXYZ)</span>
<span class="sd">    </span>
<span class="sd">    :param uvpts: Pixel coordinates</span>
<span class="sd">    :type uvpts: list</span>
<span class="sd">    :param xyzpts: XYZ coordinates</span>
<span class="sd">    :type xyzpts: list</span>
<span class="sd">    :param imn: Image names</span>
<span class="sd">    :type imn: list</span>
<span class="sd">    :param pxdestination: File directory where UV coordinates will be written to</span>
<span class="sd">    :type pxdestination: str</span>
<span class="sd">    :param xyzdestination: File directory where XYZ coordinates will be written </span>
<span class="sd">to</span>
<span class="sd">    :type xyzdestination: str    </span>
<span class="sd">    &#39;&#39;&#39;</span>    
    <span class="c1">#Pixel line coordinates file generation             </span>
    <span class="k">if</span> <span class="n">uvpts</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>            
        <span class="n">f</span> <span class="o">=</span> <span class="nb">open</span><span class="p">(</span><span class="n">pxdestination</span><span class="p">,</span> <span class="s1">&#39;w&#39;</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">uvpts</span><span class="p">)):</span>
            <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s1">&#39;Img &#39;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">imn</span><span class="p">[</span><span class="n">i</span><span class="p">])</span> <span class="o">+</span> <span class="s1">&#39;</span><span class="se">\t</span><span class="s1">&#39;</span><span class="p">)</span>                                   
            <span class="k">for</span> <span class="n">pts</span> <span class="ow">in</span> <span class="n">uvpts</span><span class="p">[</span><span class="n">i</span><span class="p">]:</span>
                <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">pts</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span> <span class="o">+</span> <span class="s1">&#39;</span><span class="se">\t</span><span class="s1">&#39;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">pts</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span> <span class="o">+</span> <span class="s1">&#39;</span><span class="se">\t</span><span class="s1">&#39;</span><span class="p">)</span>    
            <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\n\n</span><span class="s1">&#39;</span><span class="p">)</span>
            
    <span class="c1">#Real line coordinates file generation</span>
    <span class="k">if</span> <span class="n">xyzpts</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>                   
        <span class="n">f</span> <span class="o">=</span> <span class="nb">open</span><span class="p">(</span><span class="n">xyzdestination</span><span class="p">,</span> <span class="s1">&#39;w&#39;</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">xyzpts</span><span class="p">)):</span>                
            <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s1">&#39;Img &#39;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">imn</span><span class="p">[</span><span class="n">i</span><span class="p">])</span> <span class="o">+</span> <span class="s1">&#39;</span><span class="se">\t</span><span class="s1">&#39;</span><span class="p">)</span>
            <span class="k">for</span> <span class="n">pts</span> <span class="ow">in</span> <span class="n">xyzpts</span><span class="p">[</span><span class="n">i</span><span class="p">]:</span>
                <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">pts</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span> <span class="o">+</span> <span class="s1">&#39;</span><span class="se">\t</span><span class="s1">&#39;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">pts</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span> <span class="o">+</span> <span class="s1">&#39;</span><span class="se">\t</span><span class="s1">&#39;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">pts</span><span class="p">[</span><span class="mi">2</span><span class="p">])</span> 
                <span class="o">+</span> <span class="s1">&#39;</span><span class="se">\t</span><span class="s1">&#39;</span><span class="p">)</span>
            <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\n\n</span><span class="s1">&#39;</span><span class="p">)</span></div>
                
            
<div class="viewcode-block" id="writeVeloSHP"><a class="viewcode-back" href="../../Modules.html#PyTrx.FileHandler.writeVeloSHP">[docs]</a><span class="k">def</span> <span class="nf">writeVeloSHP</span><span class="p">(</span><span class="n">xyzvel</span><span class="p">,</span> <span class="n">xyzerr</span><span class="p">,</span> <span class="n">xyz0</span><span class="p">,</span> <span class="n">imn</span><span class="p">,</span> <span class="n">fileDirectory</span><span class="p">,</span> <span class="n">projection</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span> 
    <span class="sd">&#39;&#39;&#39;Write OGR real velocity points (from ALL images) to file in a .shp</span>
<span class="sd">    file type that is compatible with ESRI mapping software.</span>
<span class="sd">    </span>
<span class="sd">    :param xyzvel: XYZ velocities</span>
<span class="sd">    :type xyzvel: list</span>
<span class="sd">    :param xyz0: XYZ pt0</span>
<span class="sd">    :type xyz0: list</span>
<span class="sd">    :param imn: Image name</span>
<span class="sd">    :type imn: list</span>
<span class="sd">    :param fileDirectory: Destination that shapefiles will be written to e.g. </span>
<span class="sd">/python_workspace/Results/</span>
<span class="sd">    :type fileDirectory: str</span>
<span class="sd">    :param projection: Coordinate projection that the shapefile will exist in. </span>
<span class="sd">This can either be an ESPG number (expressed as an integer) or a well-known </span>
<span class="sd">geographical coordinate system (expressed as a string). Well-known geographical </span>
<span class="sd">coordinate systems are: &#39;WGS84&#39;, &#39;WGS72&#39;, NAD83&#39; or &#39;EPSG:n&#39;</span>
<span class="sd">    :type projection: int/str</span>
<span class="sd">    &#39;&#39;&#39;</span> 
    <span class="c1">#Make directory if it does not exist</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">fileDirectory</span><span class="p">):</span>
        <span class="n">os</span><span class="o">.</span><span class="n">makedirs</span><span class="p">(</span><span class="n">fileDirectory</span><span class="p">)</span>
        
    <span class="c1">#Get driver and create shapeData in shp file directory              </span>
    <span class="n">typ</span> <span class="o">=</span> <span class="s1">&#39;ESRI Shapefile&#39;</span>
    <span class="n">driver</span> <span class="o">=</span> <span class="n">ogr</span><span class="o">.</span><span class="n">GetDriverByName</span><span class="p">(</span><span class="n">typ</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">driver</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">IOError</span><span class="p">(</span><span class="s1">&#39;</span><span class="si">%s</span><span class="s1"> Driver not available:</span><span class="se">\n</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="n">typ</span><span class="p">)</span>
        <span class="k">pass</span>
        
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">xyzvel</span><span class="p">)):</span> 
        
        <span class="c1">#Get velocity, pt and image name for time step</span>
        <span class="n">vel</span> <span class="o">=</span> <span class="n">xyzvel</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
        <span class="k">if</span> <span class="n">xyzerr</span> <span class="o">!=</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">err</span> <span class="o">=</span> <span class="n">xyzerr</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
        <span class="n">pt0</span> <span class="o">=</span> <span class="n">xyz0</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>            
        <span class="n">im</span> <span class="o">=</span> <span class="n">imn</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> 
        
        <span class="c1">#Create file space            </span>
        <span class="n">shp</span> <span class="o">=</span> <span class="n">fileDirectory</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">im</span><span class="p">)</span> <span class="o">+</span> <span class="s1">&#39;_vel.shp&#39;</span>
        <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">shp</span><span class="p">):</span>
            <span class="n">driver</span><span class="o">.</span><span class="n">DeleteDataSource</span><span class="p">(</span><span class="n">shp</span><span class="p">)</span>
        <span class="n">ds</span> <span class="o">=</span> <span class="n">driver</span><span class="o">.</span><span class="n">CreateDataSource</span><span class="p">(</span><span class="n">shp</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">ds</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Could not create file &#39;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">shp</span><span class="p">))</span>
        
        <span class="c1">#Set projection</span>
        <span class="k">if</span> <span class="nb">type</span><span class="p">(</span><span class="n">projection</span><span class="p">)</span> <span class="ow">is</span> <span class="nb">int</span><span class="p">:</span>
            <span class="n">proj</span> <span class="o">=</span> <span class="n">osr</span><span class="o">.</span><span class="n">SpatialReference</span><span class="p">()</span>
            <span class="n">proj</span><span class="o">.</span><span class="n">ImportFromEPSG</span><span class="p">(</span><span class="n">projection</span><span class="p">)</span>
            <span class="n">layer</span> <span class="o">=</span> <span class="n">ds</span><span class="o">.</span><span class="n">CreateLayer</span><span class="p">(</span><span class="s1">&#39; &#39;</span><span class="p">,</span> <span class="n">proj</span><span class="p">,</span> <span class="n">ogr</span><span class="o">.</span><span class="n">wkbPoint</span><span class="p">)</span>
        <span class="k">elif</span> <span class="nb">type</span><span class="p">(</span><span class="n">projection</span><span class="p">)</span> <span class="ow">is</span> <span class="nb">str</span><span class="p">:</span>
            <span class="n">proj</span> <span class="o">=</span> <span class="n">osr</span><span class="o">.</span><span class="n">SpatialReference</span><span class="p">()</span>
            <span class="n">proj</span><span class="o">.</span><span class="n">SetWellKnownGeogCS</span><span class="p">(</span><span class="n">projection</span><span class="p">)</span>
            <span class="n">layer</span> <span class="o">=</span> <span class="n">ds</span><span class="o">.</span><span class="n">CreateLayer</span><span class="p">(</span><span class="s1">&#39; &#39;</span><span class="p">,</span> <span class="n">proj</span><span class="p">,</span> <span class="n">ogr</span><span class="o">.</span><span class="n">wkbPoint</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">layer</span> <span class="o">=</span> <span class="n">ds</span><span class="o">.</span><span class="n">CreateLayer</span><span class="p">(</span><span class="s1">&#39; &#39;</span><span class="p">,</span> <span class="kc">None</span><span class="p">,</span> <span class="n">ogr</span><span class="o">.</span><span class="n">wkbPoint</span><span class="p">)</span>
   
        <span class="c1">#Add attributes to layer</span>
        <span class="n">layer</span><span class="o">.</span><span class="n">CreateField</span><span class="p">(</span><span class="n">ogr</span><span class="o">.</span><span class="n">FieldDefn</span><span class="p">(</span><span class="s1">&#39;id&#39;</span><span class="p">,</span> <span class="n">ogr</span><span class="o">.</span><span class="n">OFTInteger</span><span class="p">))</span>     <span class="c1">#ID    </span>
        <span class="n">layer</span><span class="o">.</span><span class="n">CreateField</span><span class="p">(</span><span class="n">ogr</span><span class="o">.</span><span class="n">FieldDefn</span><span class="p">(</span><span class="s1">&#39;velocity&#39;</span><span class="p">,</span> <span class="n">ogr</span><span class="o">.</span><span class="n">OFTReal</span><span class="p">))</span>  <span class="c1">#Velo</span>
        <span class="n">layer</span><span class="o">.</span><span class="n">CreateField</span><span class="p">(</span><span class="n">ogr</span><span class="o">.</span><span class="n">FieldDefn</span><span class="p">(</span><span class="s1">&#39;error&#39;</span><span class="p">,</span> <span class="n">ogr</span><span class="o">.</span><span class="n">OFTReal</span><span class="p">))</span>  <span class="c1">#Velo        </span>
        <span class="n">layer</span><span class="o">.</span><span class="n">CreateField</span><span class="p">(</span><span class="n">ogr</span><span class="o">.</span><span class="n">FieldDefn</span><span class="p">(</span><span class="s1">&#39;snr&#39;</span><span class="p">,</span> <span class="n">ogr</span><span class="o">.</span><span class="n">OFTReal</span><span class="p">))</span>  <span class="c1">#Velo </span>
        
        <span class="c1">#Get xy coordinates</span>
        <span class="n">x0</span> <span class="o">=</span> <span class="n">pt0</span><span class="p">[:,</span><span class="mi">0</span><span class="p">]</span>
        <span class="n">y0</span> <span class="o">=</span> <span class="n">pt0</span><span class="p">[:,</span><span class="mi">1</span><span class="p">]</span>
        
        <span class="c1">#Create point features with data attributes in layer</span>
        <span class="k">if</span> <span class="n">xyzerr</span> <span class="o">!=</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">v</span><span class="p">,</span><span class="n">e</span><span class="p">,</span><span class="n">x</span><span class="p">,</span><span class="n">y</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">vel</span><span class="p">,</span> <span class="n">err</span><span class="p">,</span> <span class="n">x0</span><span class="p">,</span> <span class="n">y0</span><span class="p">):</span>
                <span class="n">count</span><span class="o">=</span><span class="mi">1</span>
            
                <span class="c1">#Create feature    </span>
                <span class="n">feature</span> <span class="o">=</span> <span class="n">ogr</span><span class="o">.</span><span class="n">Feature</span><span class="p">(</span><span class="n">layer</span><span class="o">.</span><span class="n">GetLayerDefn</span><span class="p">())</span>
            
                <span class="c1">#Create feature attributes    </span>
                <span class="n">feature</span><span class="o">.</span><span class="n">SetField</span><span class="p">(</span><span class="s1">&#39;id&#39;</span><span class="p">,</span> <span class="n">count</span><span class="p">)</span>
                <span class="n">feature</span><span class="o">.</span><span class="n">SetField</span><span class="p">(</span><span class="s1">&#39;velocity&#39;</span><span class="p">,</span> <span class="n">v</span><span class="p">)</span>
                <span class="n">feature</span><span class="o">.</span><span class="n">SetField</span><span class="p">(</span><span class="s1">&#39;error&#39;</span><span class="p">,</span> <span class="n">e</span><span class="p">)</span>
                <span class="n">feature</span><span class="o">.</span><span class="n">SetField</span><span class="p">(</span><span class="s1">&#39;snr&#39;</span><span class="p">,</span> <span class="n">e</span><span class="o">/</span><span class="n">v</span><span class="p">)</span>
                
                <span class="c1">#Create feature location</span>
                <span class="n">wkt</span> <span class="o">=</span> <span class="s2">&quot;POINT(</span><span class="si">%f</span><span class="s2"> </span><span class="si">%f</span><span class="s2">)&quot;</span> <span class="o">%</span>  <span class="p">(</span><span class="nb">float</span><span class="p">(</span><span class="n">x</span><span class="p">)</span> <span class="p">,</span> <span class="nb">float</span><span class="p">(</span><span class="n">y</span><span class="p">))</span>
                <span class="n">point</span> <span class="o">=</span> <span class="n">ogr</span><span class="o">.</span><span class="n">CreateGeometryFromWkt</span><span class="p">(</span><span class="n">wkt</span><span class="p">)</span>
                <span class="n">feature</span><span class="o">.</span><span class="n">SetGeometry</span><span class="p">(</span><span class="n">point</span><span class="p">)</span>
                <span class="n">layer</span><span class="o">.</span><span class="n">CreateFeature</span><span class="p">(</span><span class="n">feature</span><span class="p">)</span>
            
                <span class="c1">#Free up data space</span>
                <span class="n">feature</span><span class="o">.</span><span class="n">Destroy</span><span class="p">()</span>                       
                <span class="n">count</span><span class="o">=</span><span class="n">count</span><span class="o">+</span><span class="mi">1</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">v</span><span class="p">,</span><span class="n">x</span><span class="p">,</span><span class="n">y</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">vel</span><span class="p">,</span> <span class="n">x0</span><span class="p">,</span> <span class="n">y0</span><span class="p">):</span>
                <span class="n">count</span><span class="o">=</span><span class="mi">1</span>
            
                <span class="c1">#Create feature    </span>
                <span class="n">feature</span> <span class="o">=</span> <span class="n">ogr</span><span class="o">.</span><span class="n">Feature</span><span class="p">(</span><span class="n">layer</span><span class="o">.</span><span class="n">GetLayerDefn</span><span class="p">())</span>
            
                <span class="c1">#Create feature attributes    </span>
                <span class="n">feature</span><span class="o">.</span><span class="n">SetField</span><span class="p">(</span><span class="s1">&#39;id&#39;</span><span class="p">,</span> <span class="n">count</span><span class="p">)</span>
                <span class="n">feature</span><span class="o">.</span><span class="n">SetField</span><span class="p">(</span><span class="s1">&#39;velocity&#39;</span><span class="p">,</span> <span class="n">v</span><span class="p">)</span>
                
                <span class="c1">#Create feature location</span>
                <span class="n">wkt</span> <span class="o">=</span> <span class="s2">&quot;POINT(</span><span class="si">%f</span><span class="s2"> </span><span class="si">%f</span><span class="s2">)&quot;</span> <span class="o">%</span>  <span class="p">(</span><span class="nb">float</span><span class="p">(</span><span class="n">x</span><span class="p">)</span> <span class="p">,</span> <span class="nb">float</span><span class="p">(</span><span class="n">y</span><span class="p">))</span>
                <span class="n">point</span> <span class="o">=</span> <span class="n">ogr</span><span class="o">.</span><span class="n">CreateGeometryFromWkt</span><span class="p">(</span><span class="n">wkt</span><span class="p">)</span>
                <span class="n">feature</span><span class="o">.</span><span class="n">SetGeometry</span><span class="p">(</span><span class="n">point</span><span class="p">)</span>
                <span class="n">layer</span><span class="o">.</span><span class="n">CreateFeature</span><span class="p">(</span><span class="n">feature</span><span class="p">)</span>
            
                <span class="c1">#Free up data space</span>
                <span class="n">feature</span><span class="o">.</span><span class="n">Destroy</span><span class="p">()</span>                       
                <span class="n">count</span><span class="o">=</span><span class="n">count</span><span class="o">+</span><span class="mi">1</span>
        <span class="c1">#Free up data space                          </span>
        <span class="n">ds</span><span class="o">.</span><span class="n">Destroy</span><span class="p">()</span></div>
        

<div class="viewcode-block" id="writeAreaSHP"><a class="viewcode-back" href="../../Modules.html#PyTrx.FileHandler.writeAreaSHP">[docs]</a><span class="k">def</span> <span class="nf">writeAreaSHP</span><span class="p">(</span><span class="n">xyzpts</span><span class="p">,</span> <span class="n">imn</span><span class="p">,</span> <span class="n">fileDirectory</span><span class="p">,</span> <span class="n">projection</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
    <span class="sd">&#39;&#39;&#39;Write OGR real polygon areas (from ALL images) to file in a .shp</span>
<span class="sd">    file type that is compatible with ESRI mapping software.</span>
<span class="sd">    </span>
<span class="sd">    :param xyzpts: XYZ coordinates for polygons</span>
<span class="sd">    :type xyzpts: list</span>
<span class="sd">    :param imn: Image name</span>
<span class="sd">    :type imn: list</span>
<span class="sd">    :param fileDirectory: Destination that shapefiles will be written to e.g. </span>
<span class="sd">/python_workspace/Results/</span>
<span class="sd">    :type fileDirectory: str</span>
<span class="sd">    :param projection: Coordinate projection that the shapefile will exist in. </span>
<span class="sd">This can either be an ESPG number (expressed as an integer) or a well-known </span>
<span class="sd">geographical coordinate system (expressed as a string). Well-known geographical </span>
<span class="sd">coordinate systems are: &#39;WGS84&#39;, &#39;WGS72&#39;, NAD83&#39; or &#39;EPSG:n&#39;</span>
<span class="sd">    :type projection: int/str</span>
<span class="sd">    &#39;&#39;&#39;</span> 
    <span class="c1">#Make directory if it does not exist</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">fileDirectory</span><span class="p">):</span>
        <span class="n">os</span><span class="o">.</span><span class="n">makedirs</span><span class="p">(</span><span class="n">fileDirectory</span><span class="p">)</span>
        
    <span class="c1">#Get driver and create shapeData in shp file directory        </span>
    <span class="n">typ</span> <span class="o">=</span> <span class="s1">&#39;ESRI Shapefile&#39;</span>        
    <span class="n">driver</span> <span class="o">=</span> <span class="n">ogr</span><span class="o">.</span><span class="n">GetDriverByName</span><span class="p">(</span><span class="n">typ</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">driver</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">IOError</span><span class="p">(</span><span class="s1">&#39;</span><span class="si">%s</span><span class="s1"> Driver not available:</span><span class="se">\n</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="n">typ</span><span class="p">)</span>
        <span class="k">pass</span>
        
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">xyzpts</span><span class="p">)):</span> 
        
        <span class="c1">#Get polygon coordinates and image name for each time step</span>
        <span class="n">polys</span> <span class="o">=</span> <span class="n">xyzpts</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>          
        <span class="n">im</span> <span class="o">=</span> <span class="n">imn</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> 
                      
        <span class="c1">#Create datasource in shapefile</span>
        <span class="n">shp</span> <span class="o">=</span> <span class="n">fileDirectory</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">im</span><span class="p">)</span> <span class="o">+</span> <span class="s1">&#39;_area.shp&#39;</span>
        
        <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">shp</span><span class="p">):</span>
            <span class="n">driver</span><span class="o">.</span><span class="n">DeleteDataSource</span><span class="p">(</span><span class="n">shp</span><span class="p">)</span>
        <span class="n">ds</span> <span class="o">=</span> <span class="n">driver</span><span class="o">.</span><span class="n">CreateDataSource</span><span class="p">(</span><span class="n">shp</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">ds</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Could not create file &#39;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">shp</span><span class="p">))</span>
    
        <span class="k">if</span> <span class="nb">type</span><span class="p">(</span><span class="n">projection</span><span class="p">)</span> <span class="ow">is</span> <span class="nb">int</span><span class="p">:</span>
            <span class="n">proj</span> <span class="o">=</span> <span class="n">osr</span><span class="o">.</span><span class="n">SpatialReference</span><span class="p">()</span>
            <span class="n">proj</span><span class="o">.</span><span class="n">ImportFromEPSG</span><span class="p">(</span><span class="n">projection</span><span class="p">)</span>
            <span class="n">layer</span> <span class="o">=</span> <span class="n">ds</span><span class="o">.</span><span class="n">CreateLayer</span><span class="p">(</span><span class="s1">&#39; &#39;</span><span class="p">,</span> <span class="n">proj</span><span class="p">,</span> <span class="n">ogr</span><span class="o">.</span><span class="n">wkbPolygon</span><span class="p">)</span>
        <span class="k">elif</span> <span class="nb">type</span><span class="p">(</span><span class="n">projection</span><span class="p">)</span> <span class="ow">is</span> <span class="nb">str</span><span class="p">:</span>
            <span class="n">proj</span> <span class="o">=</span> <span class="n">osr</span><span class="o">.</span><span class="n">SpatialReference</span><span class="p">()</span>
            <span class="n">proj</span><span class="o">.</span><span class="n">SetWellKnownGeogCS</span><span class="p">(</span><span class="n">projection</span><span class="p">)</span>
            <span class="n">layer</span> <span class="o">=</span> <span class="n">ds</span><span class="o">.</span><span class="n">CreateLayer</span><span class="p">(</span><span class="s1">&#39; &#39;</span><span class="p">,</span> <span class="n">proj</span><span class="p">,</span> <span class="n">ogr</span><span class="o">.</span><span class="n">wkbPolygon</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">layer</span> <span class="o">=</span> <span class="n">ds</span><span class="o">.</span><span class="n">CreateLayer</span><span class="p">(</span><span class="s1">&#39; &#39;</span><span class="p">,</span> <span class="kc">None</span><span class="p">,</span> <span class="n">ogr</span><span class="o">.</span><span class="n">wkbPolygon</span><span class="p">)</span>
    
        <span class="c1">#Add attributes</span>
        <span class="n">layer</span><span class="o">.</span><span class="n">CreateField</span><span class="p">(</span><span class="n">ogr</span><span class="o">.</span><span class="n">FieldDefn</span><span class="p">(</span><span class="s1">&#39;id&#39;</span><span class="p">,</span> <span class="n">ogr</span><span class="o">.</span><span class="n">OFTInteger</span><span class="p">))</span>
        <span class="n">layer</span><span class="o">.</span><span class="n">CreateField</span><span class="p">(</span><span class="n">ogr</span><span class="o">.</span><span class="n">FieldDefn</span><span class="p">(</span><span class="s1">&#39;area&#39;</span><span class="p">,</span> <span class="n">ogr</span><span class="o">.</span><span class="n">OFTReal</span><span class="p">))</span>
        
        <span class="c1">#Get ogr polygons from xyz areal data at given image </span>
        <span class="n">ogrpolys</span> <span class="o">=</span> <span class="p">[]</span>        
        <span class="k">for</span> <span class="n">shape</span> <span class="ow">in</span> <span class="n">polys</span><span class="p">:</span>
            <span class="n">ring</span> <span class="o">=</span> <span class="n">ogr</span><span class="o">.</span><span class="n">Geometry</span><span class="p">(</span><span class="n">ogr</span><span class="o">.</span><span class="n">wkbLinearRing</span><span class="p">)</span>
            <span class="k">for</span> <span class="n">pt</span> <span class="ow">in</span> <span class="n">shape</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">np</span><span class="o">.</span><span class="n">isnan</span><span class="p">(</span><span class="n">pt</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span> <span class="o">==</span> <span class="kc">False</span><span class="p">:</span>                   
                    <span class="n">ring</span><span class="o">.</span><span class="n">AddPoint</span><span class="p">(</span><span class="n">pt</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span><span class="n">pt</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span><span class="n">pt</span><span class="p">[</span><span class="mi">2</span><span class="p">])</span>
            <span class="n">poly</span> <span class="o">=</span> <span class="n">ogr</span><span class="o">.</span><span class="n">Geometry</span><span class="p">(</span><span class="n">ogr</span><span class="o">.</span><span class="n">wkbPolygon</span><span class="p">)</span>
            <span class="n">poly</span><span class="o">.</span><span class="n">AddGeometry</span><span class="p">(</span><span class="n">ring</span><span class="p">)</span>
            <span class="n">ogrpolys</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">poly</span><span class="p">)</span>
            
        <span class="n">polycount</span><span class="o">=</span><span class="mi">1</span>

        <span class="c1">#Create feature            </span>
        <span class="k">for</span> <span class="n">p</span> <span class="ow">in</span> <span class="n">ogrpolys</span><span class="p">:</span>
            <span class="n">feature</span> <span class="o">=</span> <span class="n">ogr</span><span class="o">.</span><span class="n">Feature</span><span class="p">(</span><span class="n">layer</span><span class="o">.</span><span class="n">GetLayerDefn</span><span class="p">())</span>
            <span class="n">feature</span><span class="o">.</span><span class="n">SetGeometry</span><span class="p">(</span><span class="n">p</span><span class="p">)</span>
            <span class="n">feature</span><span class="o">.</span><span class="n">SetField</span><span class="p">(</span><span class="s1">&#39;id&#39;</span><span class="p">,</span> <span class="n">polycount</span><span class="p">)</span>
            <span class="n">feature</span><span class="o">.</span><span class="n">SetField</span><span class="p">(</span><span class="s1">&#39;area&#39;</span><span class="p">,</span> <span class="n">p</span><span class="o">.</span><span class="n">Area</span><span class="p">())</span>
            <span class="n">layer</span><span class="o">.</span><span class="n">CreateFeature</span><span class="p">(</span><span class="n">feature</span><span class="p">)</span>
            <span class="n">feature</span><span class="o">.</span><span class="n">Destroy</span><span class="p">()</span>                
            <span class="n">polycount</span><span class="o">=</span><span class="n">polycount</span><span class="o">+</span><span class="mi">1</span>
        
        <span class="n">ds</span><span class="o">.</span><span class="n">Destroy</span><span class="p">()</span></div>
        
        
<div class="viewcode-block" id="writeLineSHP"><a class="viewcode-back" href="../../Modules.html#PyTrx.FileHandler.writeLineSHP">[docs]</a><span class="k">def</span> <span class="nf">writeLineSHP</span><span class="p">(</span><span class="n">xyzpts</span><span class="p">,</span> <span class="n">imn</span><span class="p">,</span> <span class="n">fileDirectory</span><span class="p">,</span> <span class="n">projection</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
    <span class="sd">&#39;&#39;&#39;Write OGR real line features (from ALL images) to file in a .shp</span>
<span class="sd">    file type that is compatible with ESRI mapping software.</span>
<span class="sd">    </span>
<span class="sd">    :param xyzpts: XYZ coordinates for polygons</span>
<span class="sd">    :type xyzpts: list</span>
<span class="sd">    :param imn: Image name</span>
<span class="sd">    :type imn: list</span>
<span class="sd">    :param fileDirectory: Destination that shapefiles will be written to e.g. </span>
<span class="sd">/python_workspace/Results/</span>
<span class="sd">    :type fileDirectory: str</span>
<span class="sd">    :param projection: Coordinate projection that the shapefile will exist in. </span>
<span class="sd">This can either be an ESPG number (expressed as an integer) or a well-known </span>
<span class="sd">geographical coordinate system (expressed as a string). Well-known geographical </span>
<span class="sd">coordinate systems are: &#39;WGS84&#39;, &#39;WGS72&#39;, NAD83&#39; or &#39;EPSG:n&#39;</span>
<span class="sd">    :type projection: int/str</span>
<span class="sd">    &#39;&#39;&#39;</span> 
    <span class="c1">#Make directory if it does not exist</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">fileDirectory</span><span class="p">):</span>
        <span class="n">os</span><span class="o">.</span><span class="n">makedirs</span><span class="p">(</span><span class="n">fileDirectory</span><span class="p">)</span>
        
    <span class="c1">#Get driver and create shapeData in shp file directory        </span>
    <span class="n">typ</span> <span class="o">=</span> <span class="s1">&#39;ESRI Shapefile&#39;</span>        
    <span class="n">driver</span> <span class="o">=</span> <span class="n">ogr</span><span class="o">.</span><span class="n">GetDriverByName</span><span class="p">(</span><span class="n">typ</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">driver</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">IOError</span><span class="p">(</span><span class="s1">&#39;</span><span class="si">%s</span><span class="s1"> Driver not available:</span><span class="se">\n</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="n">typ</span><span class="p">)</span>
        <span class="k">pass</span>
       
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">xyzpts</span><span class="p">)):</span>
        
        <span class="c1">#Get polygon coordinates and image name for each time step</span>
        <span class="n">rline</span> <span class="o">=</span> <span class="n">xyzpts</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>  
        <span class="n">im</span> <span class="o">=</span> <span class="n">imn</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>

        <span class="c1">#Create datasource in shapefile</span>
        <span class="n">shp</span> <span class="o">=</span> <span class="n">fileDirectory</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">im</span><span class="p">)</span> <span class="o">+</span> <span class="s1">&#39;_line.shp&#39;</span>
        
        <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">shp</span><span class="p">):</span>
            <span class="n">driver</span><span class="o">.</span><span class="n">DeleteDataSource</span><span class="p">(</span><span class="n">shp</span><span class="p">)</span>
        <span class="n">ds</span> <span class="o">=</span> <span class="n">driver</span><span class="o">.</span><span class="n">CreateDataSource</span><span class="p">(</span><span class="n">shp</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">ds</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Could not create file &#39;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">shp</span><span class="p">))</span>
    
        <span class="k">if</span> <span class="nb">type</span><span class="p">(</span><span class="n">projection</span><span class="p">)</span> <span class="ow">is</span> <span class="nb">int</span><span class="p">:</span>
            <span class="n">proj</span> <span class="o">=</span> <span class="n">osr</span><span class="o">.</span><span class="n">SpatialReference</span><span class="p">()</span>
            <span class="n">proj</span><span class="o">.</span><span class="n">ImportFromEPSG</span><span class="p">(</span><span class="n">projection</span><span class="p">)</span>
            <span class="n">layer</span> <span class="o">=</span> <span class="n">ds</span><span class="o">.</span><span class="n">CreateLayer</span><span class="p">(</span><span class="s1">&#39; &#39;</span><span class="p">,</span> <span class="n">proj</span><span class="p">,</span> <span class="n">ogr</span><span class="o">.</span><span class="n">wkbLineString</span><span class="p">)</span>
        <span class="k">elif</span> <span class="nb">type</span><span class="p">(</span><span class="n">projection</span><span class="p">)</span> <span class="ow">is</span> <span class="nb">str</span><span class="p">:</span>
            <span class="n">proj</span> <span class="o">=</span> <span class="n">osr</span><span class="o">.</span><span class="n">SpatialReference</span><span class="p">()</span>
            <span class="n">proj</span><span class="o">.</span><span class="n">SetWellKnownGeogCS</span><span class="p">(</span><span class="n">projection</span><span class="p">)</span>
            <span class="n">layer</span> <span class="o">=</span> <span class="n">ds</span><span class="o">.</span><span class="n">CreateLayer</span><span class="p">(</span><span class="s1">&#39; &#39;</span><span class="p">,</span> <span class="n">proj</span><span class="p">,</span> <span class="n">ogr</span><span class="o">.</span><span class="n">wkbLineString</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">layer</span> <span class="o">=</span> <span class="n">ds</span><span class="o">.</span><span class="n">CreateLayer</span><span class="p">(</span><span class="s1">&#39; &#39;</span><span class="p">,</span> <span class="kc">None</span><span class="p">,</span> <span class="n">ogr</span><span class="o">.</span><span class="n">wkbLineString</span><span class="p">)</span>
        
        <span class="c1">#Add attributes</span>
        <span class="n">layer</span><span class="o">.</span><span class="n">CreateField</span><span class="p">(</span><span class="n">ogr</span><span class="o">.</span><span class="n">FieldDefn</span><span class="p">(</span><span class="s1">&#39;id&#39;</span><span class="p">,</span> <span class="n">ogr</span><span class="o">.</span><span class="n">OFTInteger</span><span class="p">))</span>
        <span class="n">layer</span><span class="o">.</span><span class="n">CreateField</span><span class="p">(</span><span class="n">ogr</span><span class="o">.</span><span class="n">FieldDefn</span><span class="p">(</span><span class="s1">&#39;length&#39;</span><span class="p">,</span> <span class="n">ogr</span><span class="o">.</span><span class="n">OFTReal</span><span class="p">))</span>

        <span class="n">lcount</span><span class="o">=</span><span class="mi">1</span>
        
        <span class="n">line</span> <span class="o">=</span> <span class="n">ogr</span><span class="o">.</span><span class="n">Geometry</span><span class="p">(</span><span class="n">ogr</span><span class="o">.</span><span class="n">wkbLineString</span><span class="p">)</span>   
        <span class="k">for</span> <span class="n">p</span> <span class="ow">in</span> <span class="n">rline</span><span class="p">:</span>
            <span class="n">line</span><span class="o">.</span><span class="n">AddPoint</span><span class="p">(</span><span class="n">p</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span><span class="n">p</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>
        
        <span class="c1">#Create feature            </span>
        <span class="n">feature</span> <span class="o">=</span> <span class="n">ogr</span><span class="o">.</span><span class="n">Feature</span><span class="p">(</span><span class="n">layer</span><span class="o">.</span><span class="n">GetLayerDefn</span><span class="p">())</span>
        <span class="n">feature</span><span class="o">.</span><span class="n">SetGeometry</span><span class="p">(</span><span class="n">line</span><span class="p">)</span>
        <span class="n">feature</span><span class="o">.</span><span class="n">SetField</span><span class="p">(</span><span class="s1">&#39;id&#39;</span><span class="p">,</span> <span class="n">lcount</span><span class="p">)</span>
        <span class="n">feature</span><span class="o">.</span><span class="n">SetField</span><span class="p">(</span><span class="s1">&#39;length&#39;</span><span class="p">,</span> <span class="n">line</span><span class="o">.</span><span class="n">Length</span><span class="p">())</span>
        <span class="n">layer</span><span class="o">.</span><span class="n">CreateFeature</span><span class="p">(</span><span class="n">feature</span><span class="p">)</span>
        <span class="n">feature</span><span class="o">.</span><span class="n">Destroy</span><span class="p">()</span> 
        <span class="n">lcount</span><span class="o">=</span><span class="n">lcount</span><span class="o">+</span><span class="mi">1</span>
        
        <span class="n">ds</span><span class="o">.</span><span class="n">Destroy</span><span class="p">()</span></div>


<div class="viewcode-block" id="importAreaData"><a class="viewcode-back" href="../../Modules.html#PyTrx.FileHandler.importAreaData">[docs]</a><span class="k">def</span> <span class="nf">importAreaData</span><span class="p">(</span><span class="n">xyzfile</span><span class="p">,</span> <span class="n">pxfile</span><span class="p">):</span>
    <span class="sd">&#39;&#39;&#39;Import xyz and px data from text files.</span>
<span class="sd">    </span>
<span class="sd">    :param xyzfile: File directory to xyz coordinates</span>
<span class="sd">    :type xyzfile: str</span>
<span class="sd">    :param pxfile: File directory to uv coordinates</span>
<span class="sd">    :type pxfile str</span>
<span class="sd">    :returns: Coordinates and areas of detected areas</span>
<span class="sd">    :rtype: list</span>
<span class="sd">    &#39;&#39;&#39;</span>
    <span class="c1">#Get real-world coordinates and areas       </span>
    <span class="n">xyz</span> <span class="o">=</span> <span class="n">importAreaFile</span><span class="p">(</span><span class="n">xyzfile</span><span class="p">,</span><span class="mi">3</span><span class="p">)</span>

    <span class="c1">#Get pixel coordinates and areas    </span>
    <span class="n">uv</span> <span class="o">=</span> <span class="n">importAreaFile</span><span class="p">(</span><span class="n">pxfile</span><span class="p">,</span><span class="mi">2</span><span class="p">)</span>

    <span class="c1">#Compile data together</span>
    <span class="n">areas</span><span class="o">=</span><span class="p">[]</span>
    <span class="k">for</span> <span class="n">i</span><span class="p">,</span><span class="n">j</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">xyz</span><span class="p">,</span> <span class="n">uv</span><span class="p">):</span>
        <span class="n">areas</span><span class="o">.</span><span class="n">append</span><span class="p">([</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">])</span>
        
    <span class="c1">#Return all area data   </span>
    <span class="k">return</span> <span class="n">areas</span></div>


<div class="viewcode-block" id="importLineData"><a class="viewcode-back" href="../../Modules.html#PyTrx.FileHandler.importLineData">[docs]</a><span class="k">def</span> <span class="nf">importLineData</span><span class="p">(</span><span class="n">xyzfile</span><span class="p">,</span> <span class="n">pxfile</span><span class="p">):</span>
    <span class="sd">&#39;&#39;&#39;Import xyz and px data from text files.</span>

<span class="sd">    :param xyzfile: File directory to xyz coordinates</span>
<span class="sd">    :type xyzfile: str</span>
<span class="sd">    :param pxfile: File directory to uv coordinates</span>
<span class="sd">    :type pxfile str</span>
<span class="sd">    :returns: Coordinates and lengths of detected lines</span>
<span class="sd">    :rtype: list</span>
<span class="sd">    &#39;&#39;&#39;</span>
    <span class="c1">#Get real-world coordinates and distances</span>
    <span class="n">xyz</span> <span class="o">=</span> <span class="n">importLineFile</span><span class="p">(</span><span class="n">xyzfile</span><span class="p">,</span> <span class="mi">3</span><span class="p">)</span>
    
    <span class="c1">#Get pixel coordinates and distances</span>
    <span class="n">uv</span> <span class="o">=</span> <span class="n">importLineFile</span><span class="p">(</span><span class="n">pxfile</span><span class="p">,</span> <span class="mi">2</span><span class="p">)</span>
    
    <span class="c1">#Compile data together</span>
    <span class="n">lines</span><span class="o">=</span><span class="p">[]</span>
    <span class="k">for</span> <span class="n">i</span><span class="p">,</span><span class="n">j</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">xyz</span><span class="p">,</span> <span class="n">uv</span><span class="p">):</span>
        <span class="n">lines</span><span class="o">.</span><span class="n">append</span><span class="p">([</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">])</span>
        
    <span class="c1">#Return all line data</span>
    <span class="k">return</span> <span class="n">lines</span></div>
   

<div class="viewcode-block" id="importAreaFile"><a class="viewcode-back" href="../../Modules.html#PyTrx.FileHandler.importAreaFile">[docs]</a><span class="k">def</span> <span class="nf">importAreaFile</span><span class="p">(</span><span class="n">fname</span><span class="p">,</span> <span class="n">dimension</span><span class="p">):</span>
    <span class="sd">&#39;&#39;&#39;Import pixel polygon data from text file and compute pixel extents.</span>
<span class="sd">      </span>
<span class="sd">    :param fname: Path to the text file containing the UV coordinate data</span>
<span class="sd">    :type fname: str</span>
<span class="sd">    :returns: Two lists, containing the UV coordinates for polygons and the</span>
<span class="sd">pixel areas for polygons</span>
<span class="sd">    :rtype: list                </span>
<span class="sd">    &#39;&#39;&#39;</span>
    <span class="c1">#Read file and detect number of images based on number of lines</span>
    <span class="n">f</span><span class="o">=</span><span class="nb">open</span><span class="p">(</span><span class="n">fname</span><span class="p">,</span><span class="s1">&#39;r&#39;</span><span class="p">)</span>      
    <span class="n">alllines</span><span class="o">=</span><span class="p">[]</span>
    <span class="k">for</span> <span class="n">line</span> <span class="ow">in</span> <span class="n">f</span><span class="o">.</span><span class="n">readlines</span><span class="p">():</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">line</span><span class="p">)</span> <span class="o">&gt;=</span> <span class="mi">6</span><span class="p">:</span>
            <span class="n">alllines</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">line</span><span class="p">)</span>  <span class="c1">#Read lines in file             </span>
    <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\n</span><span class="s1">Detected coordinates from &#39;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">alllines</span><span class="p">))</span> <span class="o">+</span> <span class="s1">&#39; images&#39;</span><span class="p">)</span>
    <span class="n">f</span><span class="o">.</span><span class="n">close</span><span class="p">()</span> 
    
    <span class="c1">#Extract strings from lines         </span>
    <span class="n">areas</span><span class="o">=</span><span class="p">[]</span> 
    <span class="k">for</span> <span class="n">line</span> <span class="ow">in</span> <span class="n">alllines</span><span class="p">:</span>        
        <span class="n">coords</span><span class="o">=</span><span class="p">[]</span>
        <span class="n">raw</span><span class="o">=</span><span class="p">[]</span>
                      
        <span class="c1">#Extract coordinate values from strings</span>
        <span class="n">vals</span> <span class="o">=</span> <span class="n">line</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\t</span><span class="s1">&#39;</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">vals</span><span class="p">:</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">a</span><span class="o">=</span><span class="nb">float</span><span class="p">(</span><span class="n">v</span><span class="p">)</span>
                <span class="n">raw</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">a</span><span class="p">)</span>
            <span class="k">except</span> <span class="ne">ValueError</span><span class="p">:</span>
                <span class="k">pass</span>
            
        <span class="k">if</span> <span class="n">dimension</span><span class="o">==</span><span class="mi">2</span><span class="p">:</span>
            <span class="n">struc</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">raw</span><span class="p">)</span><span class="o">/</span><span class="mi">2</span>
            <span class="n">coords</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">raw</span><span class="p">)</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="n">struc</span><span class="p">,</span> <span class="mi">2</span><span class="p">)</span>
        <span class="k">elif</span> <span class="n">dimension</span><span class="o">==</span><span class="mi">3</span><span class="p">:</span>
            <span class="n">struc</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">raw</span><span class="p">)</span><span class="o">/</span><span class="mi">3</span>
            <span class="n">coords</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">raw</span><span class="p">)</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="n">struc</span><span class="p">,</span> <span class="mi">3</span><span class="p">)</span>
        
        <span class="c1">#Create geometries from polgon values using ogr               </span>
        <span class="n">ring</span> <span class="o">=</span> <span class="n">ogr</span><span class="o">.</span><span class="n">Geometry</span><span class="p">(</span><span class="n">ogr</span><span class="o">.</span><span class="n">wkbLinearRing</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">pt</span> <span class="ow">in</span> <span class="n">coords</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">dimension</span><span class="o">==</span><span class="mi">2</span><span class="p">:</span>                   
                <span class="n">ring</span><span class="o">.</span><span class="n">AddPoint</span><span class="p">(</span><span class="n">pt</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span><span class="n">pt</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>
            <span class="k">elif</span> <span class="n">dimension</span><span class="o">==</span><span class="mi">3</span><span class="p">:</span>
                <span class="n">ring</span><span class="o">.</span><span class="n">AddPoint</span><span class="p">(</span><span class="n">pt</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span><span class="n">pt</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span><span class="n">pt</span><span class="p">[</span><span class="mi">2</span><span class="p">])</span>
        <span class="n">poly</span> <span class="o">=</span> <span class="n">ogr</span><span class="o">.</span><span class="n">Geometry</span><span class="p">(</span><span class="n">ogr</span><span class="o">.</span><span class="n">wkbPolygon</span><span class="p">)</span>
        <span class="n">poly</span><span class="o">.</span><span class="n">AddGeometry</span><span class="p">(</span><span class="n">ring</span><span class="p">)</span> 
        
        <span class="c1">#Append coordinates and polygon area</span>
        <span class="n">areas</span><span class="o">.</span><span class="n">append</span><span class="p">([[</span><span class="n">poly</span><span class="o">.</span><span class="n">GetArea</span><span class="p">()],[</span><span class="n">coords</span><span class="p">]])</span>
    
    <span class="k">return</span> <span class="n">areas</span></div>
     
     
<div class="viewcode-block" id="importLineFile"><a class="viewcode-back" href="../../Modules.html#PyTrx.FileHandler.importLineFile">[docs]</a><span class="k">def</span> <span class="nf">importLineFile</span><span class="p">(</span><span class="n">fname</span><span class="p">,</span> <span class="n">dimension</span><span class="p">):</span>
    <span class="sd">&#39;&#39;&#39;Import XYZ line data from text file and compute line lengths.</span>
<span class="sd">        </span>
<span class="sd">    :param fname: Path to the text file containing the XYZ coordinate data</span>
<span class="sd">    :type fname: str</span>
<span class="sd">    :param dimension: Number of dimensions in point coordinates i.e. 2 or 3</span>
<span class="sd">    :type dimension: int    </span>
<span class="sd">    :returns: List containing line coordinates and lengths</span>
<span class="sd">    :rtype: list </span>
<span class="sd">    &#39;&#39;&#39;</span>
    <span class="c1">#Read file and detect number of images based on number of lines</span>
    <span class="n">f</span><span class="o">=</span><span class="nb">open</span><span class="p">(</span><span class="n">fname</span><span class="p">,</span><span class="s1">&#39;r&#39;</span><span class="p">)</span>      
    <span class="n">alllines</span><span class="o">=</span><span class="p">[]</span>
    <span class="k">for</span> <span class="n">line</span> <span class="ow">in</span> <span class="n">f</span><span class="o">.</span><span class="n">readlines</span><span class="p">():</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">line</span><span class="p">)</span> <span class="o">&gt;=</span> <span class="mi">6</span><span class="p">:</span>
            <span class="n">alllines</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">line</span><span class="p">)</span>  <span class="c1">#Read lines in file             </span>
    <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\n</span><span class="s1">Detected coordinates from &#39;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">alllines</span><span class="p">))</span> <span class="o">+</span> <span class="s1">&#39; images&#39;</span><span class="p">)</span>
    <span class="n">f</span><span class="o">.</span><span class="n">close</span><span class="p">()</span> 
    
    <span class="c1">#Extract strings from lines         </span>
    <span class="n">lines</span><span class="o">=</span><span class="p">[]</span> 
    <span class="k">for</span> <span class="n">line</span> <span class="ow">in</span> <span class="n">alllines</span><span class="p">:</span>        
        <span class="n">coords</span><span class="o">=</span><span class="p">[]</span>
        <span class="n">raw</span><span class="o">=</span><span class="p">[]</span>
                      
        <span class="c1">#Extract coordinate values from strings</span>
        <span class="n">vals</span> <span class="o">=</span> <span class="n">line</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\t</span><span class="s1">&#39;</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">vals</span><span class="p">:</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">a</span><span class="o">=</span><span class="nb">float</span><span class="p">(</span><span class="n">v</span><span class="p">)</span>
                <span class="n">raw</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">a</span><span class="p">)</span>
            <span class="k">except</span> <span class="ne">ValueError</span><span class="p">:</span>
                <span class="k">pass</span>
            
        <span class="c1">#Restructure coordinates based into 2D or 3D points</span>
        <span class="k">if</span> <span class="n">dimension</span><span class="o">==</span><span class="mi">2</span><span class="p">:</span>
            <span class="n">struc</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">raw</span><span class="p">)</span><span class="o">/</span><span class="mi">2</span>            
            <span class="n">coords</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">raw</span><span class="p">)</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="n">struc</span><span class="p">,</span> <span class="mi">2</span><span class="p">)</span>
        <span class="k">elif</span> <span class="n">dimension</span><span class="o">==</span><span class="mi">3</span><span class="p">:</span>
            <span class="n">struc</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">raw</span><span class="p">)</span><span class="o">/</span><span class="mi">3</span>            
            <span class="n">coords</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">raw</span><span class="p">)</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="n">struc</span><span class="p">,</span> <span class="mi">3</span><span class="p">)</span>
     
        <span class="c1">#Create OGR line object       </span>
        <span class="n">ogrline</span> <span class="o">=</span> <span class="n">ogr</span><span class="o">.</span><span class="n">Geometry</span><span class="p">(</span><span class="n">ogr</span><span class="o">.</span><span class="n">wkbLineString</span><span class="p">)</span>   
        <span class="k">for</span> <span class="n">p</span> <span class="ow">in</span> <span class="n">coords</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">dimension</span><span class="o">==</span><span class="mi">2</span><span class="p">:</span>
                <span class="n">ogrline</span><span class="o">.</span><span class="n">AddPoint</span><span class="p">(</span><span class="n">p</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span><span class="n">p</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>
            <span class="k">elif</span> <span class="n">dimension</span><span class="o">==</span><span class="mi">3</span><span class="p">:</span>
                <span class="n">ogrline</span><span class="o">.</span><span class="n">AddPoint</span><span class="p">(</span><span class="n">p</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span><span class="n">p</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span><span class="n">p</span><span class="p">[</span><span class="mi">2</span><span class="p">])</span>
        <span class="n">lines</span><span class="o">.</span><span class="n">append</span><span class="p">([</span><span class="n">ogrline</span><span class="o">.</span><span class="n">Length</span><span class="p">(),</span><span class="n">coords</span><span class="p">])</span>
    
    <span class="k">return</span> <span class="n">lines</span></div>
   
    
<span class="c1">#------------------------------------------------------------------------------</span>

<span class="c1">#if __name__ == &quot;__main__&quot;:   </span>
<span class="c1">#    print &#39;\nProgram finished&#39;</span>

<span class="c1">#------------------------------------------------------------------------------   </span>
</pre></div>

          </div>
        </div>
      </div>
      <div class="sphinxsidebar" role="navigation" aria-label="main navigation">
        <div class="sphinxsidebarwrapper">
<div id="searchbox" style="display: none" role="search">
  <h3 id="searchlabel">Quick search</h3>
    <div class="searchformwrapper">
    <form class="search" action="../../search.html" method="get">
      <input type="text" name="q" aria-labelledby="searchlabel" />
      <input type="submit" value="Go" />
    </form>
    </div>
</div>
<script type="text/javascript">$('#searchbox').show(0);</script>
        </div>
      </div>
      <div class="clearer"></div>
    </div>
    <div class="related" role="navigation" aria-label="related navigation">
      <h3>Navigation</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="../../genindex.html" title="General Index"
             >index</a></li>
        <li class="right" >
          <a href="../../py-modindex.html" title="Python Module Index"
             >modules</a> |</li>
        <li class="nav-item nav-item-0"><a href="../../index.html">PyTrx 1.1.0 documentation</a> &#187;</li>
          <li class="nav-item nav-item-1"><a href="../index.html" >Module code</a> &#187;</li> 
      </ul>
    </div>
    <div class="footer" role="contentinfo">
        &#169; Copyright 2020, Penelope How, Nick Hulton, Lynne Buie.
      Created using <a href="http://sphinx-doc.org/">Sphinx</a> 2.2.0.
    </div>
  </body>
</html>